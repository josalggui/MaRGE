<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>seq.mriBlankSeq &mdash; MaRGE 0.8.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=486e5634"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            MaRGE
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../seq.html">API reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MaRGE</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">seq.mriBlankSeq</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for seq.mriBlankSeq</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Thu June 2 2022</span>
<span class="sd">@author: J.M. Algar√≠n, MRILab, i3M, CSIC, Valencia</span>
<span class="sd">@email: josalggui@i3m.upv.es</span>
<span class="sd">@Summary: mri blank sequence with common methods that will be inherited by any sequence</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">bm4d</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">configs.hw_config</span> <span class="k">as</span> <span class="nn">hw</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">scipy.io</span> <span class="kn">import</span> <span class="n">savemat</span><span class="p">,</span> <span class="n">loadmat</span>
<span class="kn">import</span> <span class="nn">controller.experiment_gui</span> <span class="k">as</span> <span class="nn">ex</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span> <span class="k">as</span> <span class="nn">sig</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">ismrmrd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">skimage.util</span> <span class="kn">import</span> <span class="n">view_as_blocks</span>
<span class="kn">from</span> <span class="nn">skimage.measure</span> <span class="kn">import</span> <span class="n">shannon_entropy</span>

<span class="c1"># Import dicom saver</span>
<span class="kn">from</span> <span class="nn">manager.dicommanager</span> <span class="kn">import</span> <span class="n">DICOMImage</span>
<span class="kn">import</span> <span class="nn">shutil</span>

<div class="viewcode-block" id="MRIBLANKSEQ">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ">[docs]</a>
<span class="k">class</span> <span class="nc">MRIBLANKSEQ</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for representing MRI sequences.</span>

<span class="sd">    This class provides functionality for creating and managing MRI sequences. It includes methods for setting</span>
<span class="sd">    parameters, generating sequences, processing data, and plotting results.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        mapKeys (list): Keys for the maps.</span>
<span class="sd">        mapNmspc (dict): Name to show in the GUI.</span>
<span class="sd">        mapVals (dict): Values to show in the GUI.</span>
<span class="sd">        mapFields (dict): Fields to classify the input parameters.</span>
<span class="sd">        mapLen (dict): Length of the input values.</span>
<span class="sd">        mapTips (dict): Tips for the input parameters.</span>
<span class="sd">        map_units (dict): Units for the input parameters.</span>
<span class="sd">        meta_data (dict): Dictionary to save meta data for DICOM files.</span>
<span class="sd">        rotations (list): List of rotation matrices.</span>
<span class="sd">        dfovs (list): List of displacement field of views.</span>
<span class="sd">        fovs (list): List of field of views.</span>
<span class="sd">        session (dict): Session information.</span>
<span class="sd">        demo (bool): Demo information.</span>
<span class="sd">        mode (string): Mode information for &#39;Standalone&#39; execution.</span>
<span class="sd">        flo_dict (dict): Dictionary containing sequence waveforms.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor method for initializing the MRIBLANKSEQ class instance.</span>

<span class="sd">        This method initializes the instance attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapKeys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapNmspc</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapFields</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapLen</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapTips</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_units</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dfovs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fovs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">demo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_name</span><span class="o">=</span><span class="s2">&quot;raw_data&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;g0&#39;</span><span class="p">:</span> <span class="p">[[],[]],</span>
                         <span class="s1">&#39;g1&#39;</span><span class="p">:</span> <span class="p">[[],[]],</span>
                         <span class="s1">&#39;g2&#39;</span><span class="p">:</span> <span class="p">[[],[]],</span>
                         <span class="s1">&#39;rx0&#39;</span><span class="p">:</span> <span class="p">[[],[]],</span>
                         <span class="s1">&#39;rx1&#39;</span><span class="p">:</span> <span class="p">[[],[]],</span>
                         <span class="s1">&#39;tx0&#39;</span><span class="p">:</span> <span class="p">[[],[]],</span>
                         <span class="s1">&#39;tx1&#39;</span><span class="p">:</span> <span class="p">[[],[]],</span>
                         <span class="s1">&#39;ttl0&#39;</span><span class="p">:</span> <span class="p">[[],[]],</span>
                         <span class="s1">&#39;ttl1&#39;</span><span class="p">:</span> <span class="p">[[],[]],}</span>


    <span class="c1"># *********************************************************************************</span>
    <span class="c1"># *********************************************************************************</span>
    <span class="c1"># *********************************************************************************</span>

    <span class="c1"># Create dictionaries of inputs classified by field (RF, SEQ, IM or OTH)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">RFproperties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve RF-related properties.</span>

<span class="sd">        Automatically selects the inputs related to RF fields and returns them along with their corresponding tips.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing RF-related properties.</span>
<span class="sd">            dict: A dictionary containing tips for RF-related properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">tips</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapKeys</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapFields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;RF&#39;</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mapNmspc</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
                <span class="n">tips</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mapNmspc</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mapTips</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">tips</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">IMproperties</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve IM-related properties.</span>

<span class="sd">        Automatically selects the inputs related to IM fields and returns them along with their corresponding tips.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing IM-related properties.</span>
<span class="sd">            dict: A dictionary containing tips for IM-related properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">tips</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapKeys</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapFields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IM&#39;</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mapNmspc</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
                <span class="n">tips</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mapNmspc</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mapTips</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">tips</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">SEQproperties</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve SEQ-related properties.</span>

<span class="sd">        Automatically selects the inputs related to SEQ fields and returns them along with their corresponding tips.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing SEQ-related properties.</span>
<span class="sd">            dict: A dictionary containing tips for SEQ-related properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">tips</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapKeys</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapFields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SEQ&#39;</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mapNmspc</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
                <span class="n">tips</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mapNmspc</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mapTips</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">tips</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">OTHproperties</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve OTH-related properties.</span>

<span class="sd">        Automatically selects the inputs related to OTH fields and returns them along with their corresponding tips.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing OTH-related properties.</span>
<span class="sd">            dict: A dictionary containing tips for OTH-related properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">tips</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapKeys</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapFields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;OTH&#39;</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mapNmspc</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
                <span class="n">tips</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mapNmspc</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mapTips</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">tips</span>

<div class="viewcode-block" id="MRIBLANKSEQ.runBatches">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.runBatches">[docs]</a>
    <span class="k">def</span> <span class="nf">runBatches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">waveforms</span><span class="p">,</span> <span class="n">n_readouts</span><span class="p">,</span> <span class="n">n_adc</span><span class="p">,</span>
                   <span class="n">frequency</span><span class="o">=</span><span class="n">hw</span><span class="o">.</span><span class="n">larmorFreq</span><span class="p">,</span>
                   <span class="n">bandwidth</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span>
                   <span class="n">decimate</span><span class="o">=</span><span class="s1">&#39;Normal&#39;</span><span class="p">,</span>
                   <span class="n">hardware</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">output</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                   <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute multiple batches of MRI waveforms, manage data acquisition, and store oversampled data.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        waveforms : dict</span>
<span class="sd">            Dictionary containing waveform sequences. Keys represent batch identifiers, and values are</span>
<span class="sd">            the corresponding waveform data generated with PyPulseq.</span>
<span class="sd">        n_readouts : dict</span>
<span class="sd">            Dictionary specifying the number of readout points for each batch. Keys match the batch</span>
<span class="sd">            identifiers, and values indicate the number of readout points.</span>
<span class="sd">        n_adc : int</span>
<span class="sd">            Number of ADC windows. Each window must have the same length.</span>
<span class="sd">        frequency : float, optional</span>
<span class="sd">            Larmor frequency in MHz for the MRI acquisition. Defaults to the system&#39;s Larmor frequency (hw.larmorFreq).</span>
<span class="sd">        bandwidth : float, optional</span>
<span class="sd">            Bandwidth in MHz used to calculate the sampling period (sampling time = 1 / bandwidth). Defaults to 0.03 MHz.</span>
<span class="sd">        decimate : str, optional</span>
<span class="sd">            Specifies the decimation method.</span>
<span class="sd">            - &#39;Normal&#39;: Decimates the acquired array without preprocessing.</span>
<span class="sd">            - &#39;PETRA&#39;: Adjusts the pre-readout points to the desired starting point.</span>
<span class="sd">        hardware: bool, optional</span>
<span class="sd">            Take into account gradient and ADC delay.</span>
<span class="sd">        output: str, optional</span>
<span class="sd">            String to add to the output keys saved in the mapVals parameter.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        bool</span>
<span class="sd">            True if all batches are executed successfully, False if an error occurs (e.g., waveform constraints exceed hardware limits).</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        - Initializes Red Pitaya hardware unless in demo mode.</span>
<span class="sd">        - Converts PyPulseq waveforms to Red Pitaya-compatible format.</span>
<span class="sd">        - If `plotSeq` is True, the sequence is plotted instead of executed.</span>
<span class="sd">        - In demo mode, simulated random data replaces hardware acquisition.</span>
<span class="sd">        - Oversampled data is stored in `self.mapVals[&#39;data_over&#39;]`.</span>
<span class="sd">        - Decimated data is stored in `self.mapVals[&#39;data_decimated&#39;]`.</span>
<span class="sd">        - Handles data loss by repeating batches until the expected points are acquired.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="s1">&#39;n_readouts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">n_readouts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="s1">&#39;n_batches&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">n_readouts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="c1"># Initialize a list to hold oversampled data</span>
        <span class="n">data_over</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Iterate through each batch of waveforms</span>
        <span class="k">for</span> <span class="n">seq_num</span> <span class="ow">in</span> <span class="n">waveforms</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># Initialize the experiment if not in demo mode</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">demo</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">expt</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="n">Experiment</span><span class="p">(</span>
                    <span class="n">lo_freq</span><span class="o">=</span><span class="n">frequency</span><span class="p">,</span>  <span class="c1"># Larmor frequency in MHz</span>
                    <span class="n">rx_t</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="n">bandwidth</span><span class="p">,</span>  <span class="c1"># Sampling time in us</span>
                    <span class="n">init_gpa</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Whether to initialize GPA board (False for now)</span>
                    <span class="n">gpa_fhdo_offset_time</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mf">0.2</span> <span class="o">/</span> <span class="mf">3.1</span><span class="p">),</span>  <span class="c1"># GPA offset time calculation</span>
                    <span class="n">auto_leds</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># Automatic control of LEDs</span>
                <span class="p">)</span>

            <span class="c1"># Convert the PyPulseq waveform to the Red Pitaya compatible format</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pypulseq2mriblankseq</span><span class="p">(</span><span class="n">waveforms</span><span class="o">=</span><span class="n">waveforms</span><span class="p">[</span><span class="n">seq_num</span><span class="p">],</span>
                                      <span class="n">shimming</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shimming</span><span class="p">,</span>
                                      <span class="n">sampling_period</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">bandwidth</span><span class="p">,</span>
                                      <span class="n">hardware</span><span class="o">=</span><span class="n">hardware</span><span class="p">,</span>
                                      <span class="p">)</span>

            <span class="c1"># Load the waveforms into Red Pitaya</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">floDict2Exp</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: Sequence waveforms out of hardware bounds&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sequence waveforms loaded successfully&quot;</span><span class="p">)</span>

            <span class="c1"># If not plotting the sequence, start scanning</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotSeq</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nScans</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scan </span><span class="si">{</span><span class="n">scan</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">, batch </span><span class="si">{</span><span class="n">seq_num</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">n_readouts</span><span class="p">)</span><span class="si">}</span><span class="s2"> running...&quot;</span><span class="p">)</span>
                    <span class="n">acquired_points</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">expected_points</span> <span class="o">=</span> <span class="n">n_readouts</span><span class="p">[</span><span class="n">seq_num</span><span class="p">]</span> <span class="o">*</span> <span class="n">hw</span><span class="o">.</span><span class="n">oversamplingFactor</span>  <span class="c1"># Expected number of points</span>

                    <span class="c1"># Continue acquiring points until we reach the expected number</span>
                    <span class="k">while</span> <span class="n">acquired_points</span> <span class="o">!=</span> <span class="n">expected_points</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">demo</span><span class="p">:</span>
                            <span class="n">rxd</span><span class="p">,</span> <span class="n">msgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expt</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>  <span class="c1"># Run the experiment and collect data</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># In demo mode, generate random data as a placeholder</span>
                            <span class="n">rxd</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rx0&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">expected_points</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">expected_points</span><span class="p">)}</span>

                        <span class="c1"># Update acquired points</span>
                        <span class="n">acquired_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">rxd</span><span class="p">[</span><span class="s1">&#39;rx0&#39;</span><span class="p">])</span>

                        <span class="c1"># Check if acquired points coincide with expected points</span>
                        <span class="k">if</span> <span class="n">acquired_points</span> <span class="o">!=</span> <span class="n">expected_points</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: data apoints lost!&quot;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Repeating batch...&quot;</span><span class="p">)</span>

                    <span class="c1"># Concatenate acquired data into the oversampled data array</span>
                    <span class="n">data_over</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data_over</span><span class="p">,</span> <span class="n">rxd</span><span class="p">[</span><span class="s1">&#39;rx0&#39;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Acquired points = </span><span class="si">{</span><span class="n">acquired_points</span><span class="si">}</span><span class="s2">, Expected points = </span><span class="si">{</span><span class="n">expected_points</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scan </span><span class="si">{</span><span class="n">scan</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">, batch </span><span class="si">{</span><span class="n">seq_num</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">n_readouts</span><span class="p">)</span><span class="si">}</span><span class="s2"> ready!&quot;</span><span class="p">)</span>

                <span class="c1"># Decimate the oversampled data and store it</span>
                <span class="k">if</span> <span class="n">output</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;data_over&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_over</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decimate</span><span class="p">(</span><span class="n">data_over</span><span class="p">,</span> <span class="n">n_adc</span><span class="o">=</span><span class="n">n_adc</span><span class="p">,</span> <span class="n">option</span><span class="o">=</span><span class="s1">&#39;Normal&#39;</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;data_decimated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;data_over_</span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_over</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decimate</span><span class="p">(</span><span class="n">data_over</span><span class="p">,</span> <span class="n">n_adc</span><span class="o">=</span><span class="n">n_adc</span><span class="p">,</span> <span class="n">option</span><span class="o">=</span><span class="s1">&#39;Normal&#39;</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;data_decimated_</span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotSeq</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">standalone</span><span class="p">:</span>
                <span class="c1"># Plot the sequence if requested and return immediately</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sequencePlot</span><span class="p">(</span><span class="n">standalone</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">standalone</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">demo</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">expt</span><span class="o">.</span><span class="fm">__del__</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.sequenceInfo">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.sequenceInfo">[docs]</a>
    <span class="k">def</span> <span class="nf">sequenceInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sequenceInfo method is empty.&quot;</span>
              <span class="s2">&quot;It is recommended to overide this method into your sequence.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.sequenceTime">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.sequenceTime">[docs]</a>
    <span class="k">def</span> <span class="nf">sequenceTime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rint</span><span class="p">(</span><span class="s2">&quot;sequenceTime method is empty.&quot;</span>
             <span class="s2">&quot;It is recommended to overide this method into your sequence.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.pypulseq2mriblankseq">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.pypulseq2mriblankseq">[docs]</a>
    <span class="k">def</span> <span class="nf">pypulseq2mriblankseq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">waveforms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">shimming</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span>
                             <span class="n">sampling_period</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                             <span class="n">hardware</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts PyPulseq waveforms into a format compatible with MRI hardware.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        waveforms : dict, optional</span>
<span class="sd">            Dictionary containing PyPulseq waveforms. The keys represent waveform types (e.g., &#39;tx0&#39;, &#39;rx0_en&#39;,</span>
<span class="sd">            &#39;grad_vx&#39;), and values are arrays of time and amplitude pairs.</span>
<span class="sd">        shimming : numpy.ndarray, optional</span>
<span class="sd">            Array of three values representing the shimming currents to apply in the x, y, and z gradients, respectively.</span>
<span class="sd">            Defaults to [0.0, 0.0, 0.0].</span>
<span class="sd">        sampling_period : float, optional</span>
<span class="sd">            Sampling period in seconds, used to account for delays in the CIC filter. Defaults to 0.0.</span>
<span class="sd">        hardware: bool, optional</span>
<span class="sd">            Take into account gradient and ADC delay</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        bool</span>
<span class="sd">            Returns True if the conversion is successful.</span>

<span class="sd">        Workflow:</span>
<span class="sd">        ---------</span>
<span class="sd">        1. **Reset flo_dict**:</span>
<span class="sd">            Initializes the flo dictionary, which stores gradient, RF, and TTL signals for MRI hardware execution.</span>

<span class="sd">        2. **Fill flo_dict**:</span>
<span class="sd">            Iterates through the input `waveforms` to populate the flo dictionary. Each key corresponds to a signal</span>
<span class="sd">            type, and the waveform data is appended.</span>

<span class="sd">        3. **Fill missing keys**:</span>
<span class="sd">            Ensures that all keys in `flo_dict` are populated, even if no data exists for certain signals. Unfilled</span>
<span class="sd">            keys are set to default arrays with zero values.</span>

<span class="sd">        4. **Apply shimming**:</span>
<span class="sd">            Adds the shimming values to the corresponding gradient channels (x, y, z).</span>

<span class="sd">        5. **Set sequence end**:</span>
<span class="sd">            Ensures all signals return to zero at the end of the sequence to finalize waveform execution.</span>

<span class="sd">        6. **Add hardware-specific corrections**:</span>
<span class="sd">            - Applies gradient latency adjustments.</span>
<span class="sd">            - Accounts for CIC filter delays in the receive (rx) signals.</span>

<span class="sd">        7. **Revalidate sequence end**:</span>
<span class="sd">            Reassesses and ensures all signal channels return to zero with a buffer period.</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        - This method processes and validates input waveform data to ensure compatibility with MRI hardware.</span>
<span class="sd">        - Hardware-specific parameters such as gradient delay (`hw.gradDelay`) and CIC filter delay</span>
<span class="sd">          (`hw.cic_delay_points`) are applied.</span>
<span class="sd">        - Any signal not specified in `waveforms` is initialized with a default value of zero.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Reset flo dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;g0&#39;</span><span class="p">:</span> <span class="p">[[],</span> <span class="p">[]],</span>
                         <span class="s1">&#39;g1&#39;</span><span class="p">:</span> <span class="p">[[],</span> <span class="p">[]],</span>
                         <span class="s1">&#39;g2&#39;</span><span class="p">:</span> <span class="p">[[],</span> <span class="p">[]],</span>
                         <span class="s1">&#39;rx0&#39;</span><span class="p">:</span> <span class="p">[[],</span> <span class="p">[]],</span>
                         <span class="s1">&#39;rx1&#39;</span><span class="p">:</span> <span class="p">[[],</span> <span class="p">[]],</span>
                         <span class="s1">&#39;tx0&#39;</span><span class="p">:</span> <span class="p">[[],</span> <span class="p">[]],</span>
                         <span class="s1">&#39;tx1&#39;</span><span class="p">:</span> <span class="p">[[],</span> <span class="p">[]],</span>
                         <span class="s1">&#39;ttl0&#39;</span><span class="p">:</span> <span class="p">[[],</span> <span class="p">[]],</span>
                         <span class="s1">&#39;ttl1&#39;</span><span class="p">:</span> <span class="p">[[],</span> <span class="p">[]],</span> <span class="p">}</span>

        <span class="c1"># Fill dictionary</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">waveforms</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;tx0&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">waveforms</span><span class="p">[</span><span class="s1">&#39;tx0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">waveforms</span><span class="p">[</span><span class="s1">&#39;tx0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;tx1&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">waveforms</span><span class="p">[</span><span class="s1">&#39;tx1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">waveforms</span><span class="p">[</span><span class="s1">&#39;tx1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;rx0_en&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">waveforms</span><span class="p">[</span><span class="s1">&#39;rx0_en&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">waveforms</span><span class="p">[</span><span class="s1">&#39;rx0_en&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;rx1_en&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">waveforms</span><span class="p">[</span><span class="s1">&#39;rx1_en&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">waveforms</span><span class="p">[</span><span class="s1">&#39;rx1_en&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;tx_gate&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">waveforms</span><span class="p">[</span><span class="s1">&#39;tx_gate&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">waveforms</span><span class="p">[</span><span class="s1">&#39;tx_gate&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;rx_gate&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">waveforms</span><span class="p">[</span><span class="s1">&#39;rx_gate&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">waveforms</span><span class="p">[</span><span class="s1">&#39;rx_gate&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;grad_vx&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">waveforms</span><span class="p">[</span><span class="s1">&#39;grad_vx&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">waveforms</span><span class="p">[</span><span class="s1">&#39;grad_vx&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;grad_vy&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">waveforms</span><span class="p">[</span><span class="s1">&#39;grad_vy&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">waveforms</span><span class="p">[</span><span class="s1">&#39;grad_vy&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;grad_vz&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">waveforms</span><span class="p">[</span><span class="s1">&#39;grad_vz&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g2&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g2&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">waveforms</span><span class="p">[</span><span class="s1">&#39;grad_vz&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Fill missing keys</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">is_unfilled</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="ow">not</span> <span class="n">sublist</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">is_unfilled</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">is_unfilled</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])]</span>

        <span class="c1"># Add shimming</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">shimming</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">shimming</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g2&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g2&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">shimming</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Set everything to zero</span>
        <span class="n">last_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="n">last_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">last_times</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endSequence</span><span class="p">(</span><span class="n">last_time</span><span class="o">+</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># Add gradient latency and CIC filter delay</span>
        <span class="k">if</span> <span class="n">hardware</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">::]</span> <span class="o">-=</span> <span class="n">hw</span><span class="o">.</span><span class="n">gradDelay</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">::]</span> <span class="o">-=</span> <span class="n">hw</span><span class="o">.</span><span class="n">gradDelay</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">::]</span> <span class="o">-=</span> <span class="n">hw</span><span class="o">.</span><span class="n">gradDelay</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">::]</span> <span class="o">+=</span> <span class="n">hw</span><span class="o">.</span><span class="n">cic_delay_points</span> <span class="o">*</span> <span class="n">sampling_period</span> <span class="o">/</span> <span class="n">hw</span><span class="o">.</span><span class="n">oversamplingFactor</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">::]</span> <span class="o">+=</span> <span class="n">hw</span><span class="o">.</span><span class="n">cic_delay_points</span> <span class="o">*</span> <span class="n">sampling_period</span> <span class="o">/</span> <span class="n">hw</span><span class="o">.</span><span class="n">oversamplingFactor</span>

        <span class="c1"># Set everything to zero (again)</span>
        <span class="n">last_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="n">last_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">last_times</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endSequence</span><span class="p">(</span><span class="n">last_time</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.getFovDisplacement">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.getFovDisplacement">[docs]</a>
    <span class="k">def</span> <span class="nf">getFovDisplacement</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the displacement to apply in the FFT reconstruction.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: The displacement vector.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">rotationMatrix</span><span class="p">(</span><span class="n">rotation</span><span class="p">):</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">rotation</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span>
            <span class="n">ux</span><span class="p">,</span> <span class="n">uy</span><span class="p">,</span> <span class="n">uz</span> <span class="o">=</span> <span class="n">rotation</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">+</span> <span class="n">ux</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ux</span> <span class="o">*</span> <span class="n">uy</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">-</span> <span class="n">uz</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ux</span> <span class="o">*</span> <span class="n">uz</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">+</span> <span class="n">uy</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">uy</span> <span class="o">*</span> <span class="n">ux</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">+</span> <span class="n">uz</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">+</span> <span class="n">uy</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">uy</span> <span class="o">*</span> <span class="n">uz</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">-</span> <span class="n">ux</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">uz</span> <span class="o">*</span> <span class="n">ux</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">-</span> <span class="n">uy</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">uz</span> <span class="o">*</span> <span class="n">uy</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">+</span> <span class="n">ux</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">+</span> <span class="n">uz</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">out</span>

        <span class="n">dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfovs</span><span class="p">)):</span>
            <span class="n">Mii</span> <span class="o">=</span> <span class="n">rotationMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotations</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="n">rii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfovs</span><span class="p">[</span><span class="n">ii</span><span class="p">]),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Mii</span><span class="p">,</span> <span class="p">(</span><span class="n">dr</span> <span class="o">+</span> <span class="n">rii</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">dr</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.getRotationMatrix">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.getRotationMatrix">[docs]</a>
    <span class="k">def</span> <span class="nf">getRotationMatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the rotation matrix to rotate through an arbitrary axis.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: The rotation matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">rotationMatrix</span><span class="p">(</span><span class="n">rotation</span><span class="p">):</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">rotation</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># * pi / 180 ? Check this</span>
            <span class="n">ux</span><span class="p">,</span> <span class="n">uy</span><span class="p">,</span> <span class="n">uz</span> <span class="o">=</span> <span class="n">rotation</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">+</span> <span class="n">ux</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ux</span> <span class="o">*</span> <span class="n">uy</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">-</span> <span class="n">uz</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ux</span> <span class="o">*</span> <span class="n">uz</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">+</span> <span class="n">uy</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">uy</span> <span class="o">*</span> <span class="n">ux</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">+</span> <span class="n">uz</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">+</span> <span class="n">uy</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">uy</span> <span class="o">*</span> <span class="n">uz</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">-</span> <span class="n">ux</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">uz</span> <span class="o">*</span> <span class="n">ux</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">-</span> <span class="n">uy</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">uz</span> <span class="o">*</span> <span class="n">uy</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">+</span> <span class="n">ux</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">+</span> <span class="n">uz</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">out</span>

        <span class="n">rotations</span> <span class="o">=</span> <span class="p">[</span><span class="n">rotationMatrix</span><span class="p">(</span><span class="n">rotation</span><span class="p">)</span> <span class="k">for</span> <span class="n">rotation</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotations</span><span class="p">]</span>
        <span class="n">rotation</span> <span class="o">=</span> <span class="n">rotations</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">M</span> <span class="ow">in</span> <span class="n">rotations</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">rotation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">rotation</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rotation</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.deleteOutput">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.deleteOutput">[docs]</a>
    <span class="k">def</span> <span class="nf">deleteOutput</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete the &#39;output&#39; attribute from the instance if it exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">):</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.saveParams">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.saveParams">[docs]</a>
    <span class="k">def</span> <span class="nf">saveParams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the parameters in mapVals variable to a CSV file.</span>

<span class="sd">        This method performs the following steps:</span>
<span class="sd">            1. Resets the `mapVals` variable by calling the `resetMapVals` method. Then only input parameters are accessible.</span>
<span class="sd">            2. Ensures that the directory &#39;experiments/parameterization&#39; exists, creating it if necessary.</span>
<span class="sd">            3. Writes the current parameter values stored in `mapVals` to a CSV file named &#39;&lt;seqName&gt;_last_parameters.csv&#39;, where &lt;seqName&gt; is the value of the &#39;seqName&#39; key in `mapVals`.</span>

<span class="sd">        The CSV file is saved in the &#39;experiments/parameterization&#39; directory, and contains the header specified by `mapKeys`.</span>

<span class="sd">        Potential exceptions:</span>
<span class="sd">            KeyError: If &#39;seqName&#39; is not a key in `mapVals`.</span>

<span class="sd">        Example:</span>
<span class="sd">            self.saveParams()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Reset the mapVals variable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resetMapVals</span><span class="p">()</span>

        <span class="c1"># Create directory if it does not exist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;experiments/parameterization&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;experiments/parameterization&#39;</span><span class="p">)</span>

        <span class="c1"># Save csv file with mapVals</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;experiments/parameterization/</span><span class="si">%s</span><span class="s1">_last_parameters.csv&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="s1">&#39;seqName&#39;</span><span class="p">],</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mapKeys</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerows</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">mapNmspc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">])</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.loadParams">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.loadParams">[docs]</a>
    <span class="k">def</span> <span class="nf">loadParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="s1">&#39;experiments/parameterization&#39;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1">## ca vient d un fichier ou directement de mon action ???</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load parameter values from a CSV file.</span>

<span class="sd">        This method loads parameter values into the `mapVals` attribute from a specified CSV file. The method first</span>
<span class="sd">        attempts to load the last saved parameters if no specific file is provided. If a file is provided, it loads</span>
<span class="sd">        parameters from the given file. The directory can be either &#39;experiments/parameterization&#39; or &#39;calibration&#39;, or</span>
<span class="sd">        any other specified directory for protocol parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            directory (str): The directory where the CSV file is located. Defaults to &#39;experiments/parameterization&#39;.</span>
<span class="sd">            file (str, optional): The specific CSV file to load. If not provided, the method loads the last saved parameters based on `seqName` in `mapVals`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError: If &#39;seqName&#39; is not found in `mapVals` when attempting to load the last parameters.</span>
<span class="sd">            FileNotFoundError: If the specified file does not exist in the given directory.</span>

<span class="sd">        Example:</span>
<span class="sd">            - self.loadParams()</span>
<span class="sd">            - self.loadParams(directory=&#39;calibration&#39;, file=&#39;calibration_parameters.csv&#39;)</span>

<span class="sd">        Notes:</span>
<span class="sd">            - This method updates the `mapVals` attribute with the new parameter values from the CSV file.</span>
<span class="sd">            - The method handles different data types (str, int, float) for each parameter key and ensures the correct</span>
<span class="sd">              type is maintained.</span>
<span class="sd">            - If a key is missing in the new parameter values, the old value is retained.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mapValsOld</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Load last parameters</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">_last_parameters.csv&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="s1">&#39;seqName&#39;</span><span class="p">]),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
                    <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                        <span class="n">mapValsNew</span> <span class="o">=</span> <span class="n">l</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">directory</span> <span class="o">==</span> <span class="s1">&#39;calibration&#39;</span><span class="p">:</span>  <span class="c1"># Load parameters from calibration directory</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">_last_parameters.csv&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">file</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
                            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                                <span class="n">mapValsNew</span> <span class="o">=</span> <span class="n">l</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Load parameters from protocol directory</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">file</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
                            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                                <span class="n">mapValsNew</span> <span class="o">=</span> <span class="n">l</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: File </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> does not exist&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: File </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> loaded&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;experiments/parameterization&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="s1">&#39;seqName&#39;</span><span class="p">]))</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">_last_parameters.csv&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;experiments/parameterization&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="s1">&#39;seqName&#39;</span><span class="p">]),</span>
                              <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
                        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                            <span class="n">mapValsNew</span> <span class="o">=</span> <span class="n">l</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Get key for corresponding modified parameter</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapKeys</span><span class="p">:</span>
                <span class="n">dataLen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapLen</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">valOld</span> <span class="o">=</span> <span class="n">mapValsOld</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">valNew</span> <span class="o">=</span> <span class="n">mapValsNew</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">valNew</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">valOld</span><span class="p">)</span>
                <span class="n">valNew</span> <span class="o">=</span> <span class="n">valNew</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">valNew</span> <span class="o">=</span> <span class="n">valNew</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">valNew</span> <span class="o">=</span> <span class="n">valNew</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">valOld</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="n">valOld</span> <span class="o">=</span> <span class="p">[</span><span class="n">valOld</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">dataLen</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">valOld</span> <span class="o">=</span> <span class="p">[</span><span class="n">valOld</span><span class="p">]</span>
                <span class="n">dataType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">valOld</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="n">inputNum</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dataLen</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">dataType</span> <span class="o">==</span> <span class="nb">float</span> <span class="ow">or</span> <span class="n">dataType</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">inputNum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">valNew</span><span class="p">[</span><span class="n">ii</span><span class="p">]))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">inputNum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">valOld</span><span class="p">[</span><span class="n">ii</span><span class="p">]))</span>
                    <span class="k">elif</span> <span class="n">dataType</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">inputNum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valNew</span><span class="p">[</span><span class="n">ii</span><span class="p">]))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">inputNum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">valOld</span><span class="p">[</span><span class="n">ii</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">inputNum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">valNew</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                            <span class="k">break</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">inputNum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">valOld</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="n">dataType</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputNum</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dataLen</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Save value into mapVals</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputNum</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputNum</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.resetMapVals">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.resetMapVals">[docs]</a>
    <span class="k">def</span> <span class="nf">resetMapVals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset the `mapVals` attribute to contain only the original keys.</span>

<span class="sd">        This method creates a new dictionary (`mapVals2`) that includes only the original keys specified in `mapKeys`</span>
<span class="sd">        and retains their corresponding values from the current `mapVals`. This effectively resets `mapVals` to its</span>
<span class="sd">        initial state defined by `mapKeys`, discarding any additional keys that may have been added during execution.</span>

<span class="sd">        Example:</span>
<span class="sd">            - self.resetMapVals()</span>

<span class="sd">        Notes:</span>
<span class="sd">            - Any additional keys in `mapVals` that are not present in `mapKeys` will be removed.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mapVals2</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapKeys</span><span class="p">:</span>
            <span class="n">mapVals2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span> <span class="o">=</span> <span class="n">mapVals2</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.sequencePlot">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.sequencePlot">[docs]</a>
    <span class="k">def</span> <span class="nf">sequencePlot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">standalone</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the TX, gradient, RX, and digital I/O sequences.</span>

<span class="sd">        This method generates step data plots for TX channels, gradient channels, RX channels, and digital I/O channels</span>
<span class="sd">        based on the data stored in `flo_dict` or obtained from an experiment object. If `standalone` is set to True,</span>
<span class="sd">        the method will create and display the plots in a new figure window. Otherwise, it returns the plot data for</span>
<span class="sd">        further use.</span>

<span class="sd">        Args:</span>
<span class="sd">            standalone (bool): If True, creates and displays the plots in a new figure window. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of plot data, each element being a list containing:</span>
<span class="sd">                - xData: List of time values for the plot.</span>
<span class="sd">                - yData: List of amplitude values for the plot.</span>
<span class="sd">                - legend: List of legend labels for the plot.</span>
<span class="sd">                - title: Title of the plot.</span>

<span class="sd">        Example:</span>
<span class="sd">            - self.sequencePlot()</span>
<span class="sd">            - self.sequencePlot(standalone=True)</span>

<span class="sd">        Notes:</span>
<span class="sd">            - The method uses a nested function `getStepData` to generate step data for plotting.</span>
<span class="sd">            - The method handles different scenarios based on the `demo` attribute and data from `flo_dict` or an</span>
<span class="sd">              experiment object.</span>
<span class="sd">            - If `demo` is True, it plots the TX, gradient, and RX channels from `flo_dict`.</span>
<span class="sd">            - If `demo` is False, it plots the channels using data from an experiment object.</span>
<span class="sd">            - The method formats the time data in milliseconds (ms) for plotting.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">getStepData</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">tStep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">sStep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">tStep</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
            <span class="n">tStep</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">::]</span>
            <span class="n">sStep</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
            <span class="n">sStep</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">tStep</span><span class="p">,</span> <span class="n">sStep</span><span class="p">]</span>

        <span class="c1"># Plots</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">demo</span><span class="p">:</span>
            <span class="c1"># Plot tx channels</span>
            <span class="n">xData</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">yData</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">legend</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># tx0_i</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
            <span class="n">dataStep</span> <span class="o">=</span> <span class="n">getStepData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">xData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataStep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">)</span>
            <span class="n">yData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataStep</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">legend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;tx0_i&#39;</span><span class="p">)</span>

            <span class="c1"># tx0_q</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
            <span class="n">dataStep</span> <span class="o">=</span> <span class="n">getStepData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">xData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataStep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">)</span>
            <span class="n">yData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataStep</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">legend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;tx0_q&#39;</span><span class="p">)</span>

            <span class="c1"># tx1_i</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
            <span class="n">dataStep</span> <span class="o">=</span> <span class="n">getStepData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">xData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataStep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">)</span>
            <span class="n">yData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataStep</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">legend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;tx1_i&#39;</span><span class="p">)</span>

            <span class="c1"># tx1_q</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
            <span class="n">dataStep</span> <span class="o">=</span> <span class="n">getStepData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">xData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataStep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">)</span>
            <span class="n">yData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataStep</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">legend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;tx1_q&#39;</span><span class="p">)</span>

            <span class="n">plotTx</span> <span class="o">=</span> <span class="p">[</span><span class="n">xData</span><span class="p">,</span> <span class="n">yData</span><span class="p">,</span> <span class="n">legend</span><span class="p">,</span> <span class="s1">&#39;Tx gate&#39;</span><span class="p">]</span>

            <span class="c1"># Plot gradients</span>
            <span class="n">xData</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">yData</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">legend</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># g0</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
            <span class="n">dataStep</span> <span class="o">=</span> <span class="n">getStepData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">xData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataStep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">)</span>
            <span class="n">yData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataStep</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">legend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;g0&#39;</span><span class="p">)</span>

            <span class="c1"># g1</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
            <span class="n">dataStep</span> <span class="o">=</span> <span class="n">getStepData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">xData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataStep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">)</span>
            <span class="n">yData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataStep</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">legend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;g1&#39;</span><span class="p">)</span>

            <span class="c1"># g2</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g2&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
            <span class="n">dataStep</span> <span class="o">=</span> <span class="n">getStepData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">xData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataStep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">)</span>
            <span class="n">yData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataStep</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">legend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;g2&#39;</span><span class="p">)</span>

            <span class="n">plotGrad</span> <span class="o">=</span> <span class="p">[</span><span class="n">xData</span><span class="p">,</span> <span class="n">yData</span><span class="p">,</span> <span class="n">legend</span><span class="p">,</span> <span class="s1">&#39;Gradients&#39;</span><span class="p">]</span>

            <span class="c1"># Plot readouts</span>
            <span class="n">xData</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">yData</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">legend</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># rx0</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
            <span class="n">dataStep</span> <span class="o">=</span> <span class="n">getStepData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">xData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataStep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">)</span>
            <span class="n">yData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataStep</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">legend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;rx0_en&#39;</span><span class="p">)</span>

            <span class="c1"># rx1</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
            <span class="n">dataStep</span> <span class="o">=</span> <span class="n">getStepData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">xData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataStep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">)</span>
            <span class="n">yData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataStep</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">legend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;rx1_en&#39;</span><span class="p">)</span>

            <span class="n">plotRx</span> <span class="o">=</span> <span class="p">[</span><span class="n">xData</span><span class="p">,</span> <span class="n">yData</span><span class="p">,</span> <span class="n">legend</span><span class="p">,</span> <span class="s1">&#39;Rx gate&#39;</span><span class="p">]</span>

            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">plotTx</span><span class="p">,</span> <span class="n">plotGrad</span><span class="p">,</span> <span class="n">plotRx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get instructions from experiment object</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expt</span><span class="o">.</span><span class="n">get_flodict</span><span class="p">()</span>

            <span class="c1"># Plot tx channels</span>
            <span class="n">xData</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">yData</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">legend</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">txl</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;tx0_i&#39;</span><span class="p">,</span> <span class="s1">&#39;tx0_q&#39;</span><span class="p">,</span> <span class="s1">&#39;tx1_i&#39;</span><span class="p">,</span> <span class="s1">&#39;tx1_q&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dataStep</span> <span class="o">=</span> <span class="n">getStepData</span><span class="p">(</span><span class="n">fd</span><span class="p">[</span><span class="n">txl</span><span class="p">])</span>
                    <span class="n">xData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataStep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">)</span>
                    <span class="n">yData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataStep</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">legend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">txl</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="n">plotTx</span> <span class="o">=</span> <span class="p">[</span><span class="n">xData</span><span class="p">,</span> <span class="n">yData</span><span class="p">,</span> <span class="n">legend</span><span class="p">,</span> <span class="s1">&#39;Tx gate&#39;</span><span class="p">]</span>

            <span class="c1"># Plot gradient channels</span>
            <span class="n">xData</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">yData</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">legend</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">gradl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expt</span><span class="o">.</span><span class="n">gradb</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dataStep</span> <span class="o">=</span> <span class="n">getStepData</span><span class="p">(</span><span class="n">fd</span><span class="p">[</span><span class="n">gradl</span><span class="p">])</span>
                    <span class="n">xData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataStep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">)</span>
                    <span class="n">yData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataStep</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">legend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gradl</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="n">plotGrad</span> <span class="o">=</span> <span class="p">[</span><span class="n">xData</span><span class="p">,</span> <span class="n">yData</span><span class="p">,</span> <span class="n">legend</span><span class="p">,</span> <span class="s1">&#39;Gradients&#39;</span><span class="p">]</span>

            <span class="c1"># Plot RX enable channels</span>
            <span class="n">xData</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">yData</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">legend</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">rxl</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rx0_en&#39;</span><span class="p">,</span> <span class="s1">&#39;rx1_en&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dataStep</span> <span class="o">=</span> <span class="n">getStepData</span><span class="p">(</span><span class="n">fd</span><span class="p">[</span><span class="n">rxl</span><span class="p">])</span>
                    <span class="n">xData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataStep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">)</span>
                    <span class="n">yData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataStep</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">legend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rxl</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="n">plotRx</span> <span class="o">=</span> <span class="p">[</span><span class="n">xData</span><span class="p">,</span> <span class="n">yData</span><span class="p">,</span> <span class="n">legend</span><span class="p">,</span> <span class="s1">&#39;Rx gate&#39;</span><span class="p">]</span>

            <span class="c1"># Plot digital outputs</span>
            <span class="n">xData</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">yData</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">legend</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">iol</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;tx_gate&#39;</span><span class="p">,</span> <span class="s1">&#39;rx_gate&#39;</span><span class="p">,</span> <span class="s1">&#39;trig_out&#39;</span><span class="p">,</span> <span class="s1">&#39;leds&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dataStep</span> <span class="o">=</span> <span class="n">getStepData</span><span class="p">(</span><span class="n">fd</span><span class="p">[</span><span class="n">iol</span><span class="p">])</span>
                    <span class="n">xData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataStep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">)</span>
                    <span class="n">yData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataStep</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">legend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iol</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="n">plotDigital</span> <span class="o">=</span> <span class="p">[</span><span class="n">xData</span><span class="p">,</span> <span class="n">yData</span><span class="p">,</span> <span class="n">legend</span><span class="p">,</span> <span class="s1">&#39;Digital&#39;</span><span class="p">]</span>

            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">plotTx</span><span class="p">,</span> <span class="n">plotGrad</span><span class="p">,</span> <span class="n">plotRx</span><span class="p">,</span> <span class="n">plotDigital</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">standalone</span><span class="p">:</span>
            <span class="c1"># Create plot window</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

            <span class="c1"># Insert plots</span>
            <span class="n">plot</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">plot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ii</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ii</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">ii</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time (ms)&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Amplitude (a.u.)&#39;</span><span class="p">)</span>
                <span class="n">plot</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">outputs</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.getIndex">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.getIndex">[docs]</a>
    <span class="k">def</span> <span class="nf">getIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etl</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nPH</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sweepMode</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate an array representing the order to sweep the k-space phase lines along an echo train length.</span>

<span class="sd">        The method creates an &#39;ind&#39; array based on the specified echo train length (ETL), number of phase encoding</span>
<span class="sd">        steps (nPH), and sweep mode. The sweep mode determines the order in which the k-space phase lines are traversed.</span>

<span class="sd">        Args:</span>
<span class="sd">            etl (int): Echo train length. Default is 1.</span>
<span class="sd">            nPH (int): Number of phase encoding steps. Default is 1.</span>
<span class="sd">            sweepMode (int): Sweep mode for k-space traversal. Default is 1.</span>
<span class="sd">                - 0: Sequential from -kMax to kMax (for T2 contrast).</span>
<span class="sd">                - 1: Center-out from 0 to kMax (for T1 or proton density contrast).</span>
<span class="sd">                - 2: Out-to-center from kMax to 0 (for T2 contrast).</span>
<span class="sd">                - 3: Niquist modulated method to reduce ghosting artifact (To be tested).</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray: An array of indices representing the k-space phase line traversal order.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n2ETL</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nPH</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">etl</span><span class="p">)</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">nPH</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sweepMode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Sequential for T2 contrast</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nPH</span> <span class="o">/</span> <span class="n">etl</span><span class="p">)):</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ind</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">nPH</span> <span class="o">+</span> <span class="n">ii</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">etl</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">sweepMode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Center-out for T1 contrast</span>
                <span class="k">if</span> <span class="n">etl</span> <span class="o">==</span> <span class="n">nPH</span><span class="p">:</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nPH</span><span class="p">)</span>
                    <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nPH</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="n">nPH</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">nPH</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nPH</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">nPH</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n2ETL</span><span class="p">):</span>
                        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ind</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nPH</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">ii</span><span class="p">,</span> <span class="n">nPH</span> <span class="o">+</span> <span class="n">ii</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">etl</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>
                                             <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nPH</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">ii</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">etl</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">sweepMode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Out-to-center for T2 contrast</span>
                <span class="k">if</span> <span class="n">etl</span> <span class="o">==</span> <span class="n">nPH</span><span class="p">:</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nPH</span><span class="p">)</span>
                    <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nPH</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="n">nPH</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">nPH</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nPH</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">nPH</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n2ETL</span><span class="p">):</span>
                        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ind</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nPH</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">ii</span><span class="p">,</span> <span class="n">nPH</span> <span class="o">+</span> <span class="n">ii</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">etl</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>
                                             <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nPH</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">ii</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">etl</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">sweepMode</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># Niquist modulated to reduce ghosting artifact</span>
                <span class="k">if</span> <span class="n">etl</span> <span class="o">==</span> <span class="n">nPH</span><span class="p">:</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nPH</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n2ETL</span><span class="p">)):</span>
                        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ind</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nPH</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n2ETL</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ii</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ind</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nPH</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n2ETL</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ii</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.fixEchoPosition">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.fixEchoPosition">[docs]</a>
    <span class="k">def</span> <span class="nf">fixEchoPosition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">echoes</span><span class="p">,</span> <span class="n">data0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adjust the position of k=0 in the echo data to the center of the acquisition window.</span>

<span class="sd">        This method uses oversampled data obtained with a given echo train length and readout gradient to determine the</span>
<span class="sd">        true position of k=0. It then shifts the sampled data to place k=0 at the center of each acquisition window for</span>
<span class="sd">        each gradient-spin-echo.</span>

<span class="sd">        Args:</span>
<span class="sd">            echoes (numpy.ndarray): The echo data array with dimensions [etl, n], where `etl` is the echo train length</span>
<span class="sd">                                    and `n` is the number of samples per echo. This echo train is acquired in a dummy</span>
<span class="sd">                                    excitation before the sequence using only the readout gradient.</span>
<span class="sd">            data0 (numpy.ndarray): The original data array to be adjusted with dimensions [channels, etl, n].</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray: The adjusted data array with k=0 positioned at the center of each acquisition window.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">etl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">echoes</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">echoes</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">echoes</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">data1</span> <span class="o">=</span> <span class="n">data0</span> <span class="o">*</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">etl</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">idx</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">idx</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">data1</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">,</span> <span class="o">-</span><span class="n">idx</span><span class="p">[</span><span class="n">ii</span><span class="p">]::]</span> <span class="o">=</span> <span class="n">data0</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">n</span> <span class="o">+</span> <span class="n">idx</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">data1</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.decimate">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.decimate">[docs]</a>
    <span class="k">def</span> <span class="nf">decimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_over</span><span class="p">,</span> <span class="n">n_adc</span><span class="p">,</span> <span class="n">option</span><span class="o">=</span><span class="s1">&#39;PETRA&#39;</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decimates oversampled MRI data, with optional preprocessing to manage oscillations and postprocessing</span>
<span class="sd">        to remove extra points.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        data_over : numpy.ndarray</span>
<span class="sd">            The oversampled data array to be decimated.</span>
<span class="sd">        n_adc : int</span>
<span class="sd">            The number of adc windows in the dataset, used to reshape and process the data appropriately.</span>
<span class="sd">        option : str, optional</span>
<span class="sd">            Preprocessing option to handle data before decimation:</span>
<span class="sd">            - &#39;PETRA&#39;: Adjusts initial points to avoid oscillations during decimation.</span>
<span class="sd">            - &#39;Normal&#39;: Applies no preprocessing (default is &#39;PETRA&#39;).</span>
<span class="sd">        remove : bool, optional</span>
<span class="sd">            If True, removes `addRdPoints` from the start and end of each readout line after decimation.</span>
<span class="sd">            Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            The decimated data array, optionally adjusted to remove extra points.</span>

<span class="sd">        Workflow:</span>
<span class="sd">        ---------</span>
<span class="sd">        1. **Preprocess data (optional)**:</span>
<span class="sd">            - For &#39;PETRA&#39; mode, reshapes the data into adc windows and adjusts the first few points of each line</span>
<span class="sd">              to avoid oscillations caused by decimation.</span>
<span class="sd">            - For &#39;Normal&#39; mode, no preprocessing is applied.</span>

<span class="sd">        2. **Decimate the signal**:</span>
<span class="sd">            - Applies a finite impulse response (FIR) filter and decimates the signal by the oversampling factor</span>
<span class="sd">              (`hw.oversamplingFactor`).</span>
<span class="sd">            - Starts decimation after skipping `(oversamplingFactor - 1) / 2` points to minimize edge effects.</span>

<span class="sd">        3. **Postprocess data (if `remove=True`)**:</span>
<span class="sd">            - Reshapes the decimated data into adc windows.</span>
<span class="sd">            - Removes `hw.addRdPoints` from the start and end of each line.</span>
<span class="sd">            - Reshapes the cleaned data back into a 1D array.</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        - This method uses the hardware-specific parameters:</span>
<span class="sd">          - `hw.oversamplingFactor`: The oversampling factor applied during data acquisition.</span>
<span class="sd">          - `hw.addRdPoints`: The number of additional readout points to include or remove.</span>
<span class="sd">        - The &#39;PETRA&#39; preprocessing mode is tailored for specialized MRI acquisitions that require smoothing of</span>
<span class="sd">          initial points to prevent oscillations.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Preprocess the signal to avoid oscillations due to decimation</span>
        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;PETRA&#39;</span><span class="p">:</span>
            <span class="n">data_over</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data_over</span><span class="p">,</span> <span class="p">(</span><span class="n">n_adc</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_adc</span><span class="p">):</span>
                <span class="n">data_over</span><span class="p">[</span><span class="n">line</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">hw</span><span class="o">.</span><span class="n">addRdPoints</span> <span class="o">*</span> <span class="n">hw</span><span class="o">.</span><span class="n">oversamplingFactor</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_over</span><span class="p">[</span>
                    <span class="n">line</span><span class="p">,</span> <span class="n">hw</span><span class="o">.</span><span class="n">addRdPoints</span> <span class="o">*</span> <span class="n">hw</span><span class="o">.</span><span class="n">oversamplingFactor</span><span class="p">]</span>
            <span class="n">data_over</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data_over</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;Normal&#39;</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Decimate the signal after &#39;fir&#39; filter</span>
        <span class="n">data_decimated</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">decimate</span><span class="p">(</span><span class="n">data_over</span><span class="p">[</span><span class="nb">int</span><span class="p">((</span><span class="n">hw</span><span class="o">.</span><span class="n">oversamplingFactor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)::],</span> <span class="n">hw</span><span class="o">.</span><span class="n">oversamplingFactor</span><span class="p">,</span>
                                      <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;fir&#39;</span><span class="p">,</span> <span class="n">zero_phase</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Remove addRdPoints</span>
        <span class="k">if</span> <span class="n">remove</span><span class="p">:</span>
            <span class="n">nPoints</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data_decimated</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">n_adc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">hw</span><span class="o">.</span><span class="n">addRdPoints</span>
            <span class="n">data_decimated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data_decimated</span><span class="p">,</span> <span class="p">(</span><span class="n">n_adc</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">data_decimated</span> <span class="o">=</span> <span class="n">data_decimated</span><span class="p">[:,</span> <span class="n">hw</span><span class="o">.</span><span class="n">addRdPoints</span><span class="p">:</span><span class="n">hw</span><span class="o">.</span><span class="n">addRdPoints</span> <span class="o">+</span> <span class="n">nPoints</span><span class="p">]</span>
            <span class="n">data_decimated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data_decimated</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data_decimated</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.rfSincPulse">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.rfSincPulse">[docs]</a>
    <span class="k">def</span> <span class="nf">rfSincPulse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tStart</span><span class="p">,</span> <span class="n">rfTime</span><span class="p">,</span> <span class="n">rfAmplitude</span><span class="p">,</span> <span class="n">rfPhase</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nLobes</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rewrite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate an RF pulse with a sinc pulse shape and the corresponding deblanking signal. It uses a Hanning window</span>
<span class="sd">        to reduce the banding of the frequency profile.</span>

<span class="sd">        Args:</span>
<span class="sd">            tStart (float): Start time of the RF pulse.</span>
<span class="sd">            rfTime (float): Duration of the RF pulse.</span>
<span class="sd">            rfAmplitude (float): Amplitude of the RF pulse.</span>
<span class="sd">            rfPhase (float): Phase of the RF pulse in radians. Default is 0.</span>
<span class="sd">            nLobes (int): Number of lobes in the sinc pulse. Default is 7.</span>
<span class="sd">            channel (int): Channel index for the RF pulse. Default is 0.</span>
<span class="sd">            rewrite (bool): Whether to rewrite the existing RF pulse. Default is True.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">txTime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">tStart</span><span class="p">,</span> <span class="n">tStart</span> <span class="o">+</span> <span class="n">rfTime</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="n">hw</span><span class="o">.</span><span class="n">blkTime</span>
        <span class="n">nZeros</span> <span class="o">=</span> <span class="p">(</span><span class="n">nLobes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">nZeros</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">nZeros</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">hanning</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">tx</span> <span class="o">/</span> <span class="n">nZeros</span><span class="p">))</span>
        <span class="n">txAmp</span> <span class="o">=</span> <span class="n">rfAmplitude</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">rfPhase</span><span class="p">)</span> <span class="o">*</span> <span class="n">hanning</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sinc</span><span class="p">(</span><span class="n">tx</span><span class="p">))</span>
        <span class="n">txGateTime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tStart</span><span class="p">,</span> <span class="n">tStart</span> <span class="o">+</span> <span class="n">hw</span><span class="o">.</span><span class="n">blkTime</span> <span class="o">+</span> <span class="n">rfTime</span><span class="p">])</span>
        <span class="n">txGateAmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">txTime</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">txAmp</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">txGateTime</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">txGateAmp</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.rfRawSincPulse">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.rfRawSincPulse">[docs]</a>
    <span class="k">def</span> <span class="nf">rfRawSincPulse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tStart</span><span class="p">,</span> <span class="n">rfTime</span><span class="p">,</span> <span class="n">rfAmplitude</span><span class="p">,</span> <span class="n">rfPhase</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nLobes</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rewrite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate an RF pulse with a sinc pulse shape. It uses a Hanning window</span>
<span class="sd">        to reduce the banding of the frequency profile.</span>

<span class="sd">        Args:</span>
<span class="sd">            tStart (float): Start time of the RF pulse.</span>
<span class="sd">            rfTime (float): Duration of the RF pulse.</span>
<span class="sd">            rfAmplitude (float): Amplitude of the RF pulse.</span>
<span class="sd">            rfPhase (float): Phase of the RF pulse in radians. Default is 0.</span>
<span class="sd">            nLobes (int): Number of lobes in the sinc pulse. Default is 7.</span>
<span class="sd">            channel (int): Channel index for the RF pulse. Default is 0.</span>
<span class="sd">            rewrite (bool): Whether to rewrite the existing RF pulse. Default is True.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">txTime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">tStart</span><span class="p">,</span> <span class="n">tStart</span> <span class="o">+</span> <span class="n">rfTime</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="n">hw</span><span class="o">.</span><span class="n">blkTime</span>
        <span class="n">nZeros</span> <span class="o">=</span> <span class="p">(</span><span class="n">nLobes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">nZeros</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">nZeros</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">hanning</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">tx</span> <span class="o">/</span> <span class="n">nZeros</span><span class="p">))</span>
        <span class="n">txAmp</span> <span class="o">=</span> <span class="n">rfAmplitude</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">rfPhase</span><span class="p">)</span> <span class="o">*</span> <span class="n">hanning</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sinc</span><span class="p">(</span><span class="n">tx</span><span class="p">))</span>
        <span class="n">txGateTime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tStart</span><span class="p">,</span> <span class="n">tStart</span> <span class="o">+</span> <span class="n">hw</span><span class="o">.</span><span class="n">blkTime</span> <span class="o">+</span> <span class="n">rfTime</span><span class="p">])</span>
        <span class="n">txGateAmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">txTime</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">txAmp</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.rfRecPulse">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.rfRecPulse">[docs]</a>
    <span class="k">def</span> <span class="nf">rfRecPulse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tStart</span><span class="p">,</span> <span class="n">rfTime</span><span class="p">,</span> <span class="n">rfAmplitude</span><span class="p">,</span> <span class="n">rfPhase</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate an RF pulse with a rectangular pulse shape and the corresponding deblanking signal.</span>

<span class="sd">        Args:</span>
<span class="sd">            tStart (float): Start time of the RF pulse.</span>
<span class="sd">            rfTime (float): Duration of the RF pulse.</span>
<span class="sd">            rfAmplitude (float): Amplitude of the RF pulse.</span>
<span class="sd">            rfPhase (float): Phase of the RF pulse in radians. Default is 0.</span>
<span class="sd">            channel (int): Channel index for the RF pulse. Default is 0.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">txTime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tStart</span> <span class="o">+</span> <span class="n">hw</span><span class="o">.</span><span class="n">blkTime</span><span class="p">,</span> <span class="n">tStart</span> <span class="o">+</span> <span class="n">hw</span><span class="o">.</span><span class="n">blkTime</span> <span class="o">+</span> <span class="n">rfTime</span><span class="p">])</span>
        <span class="n">txAmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">rfAmplitude</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">rfPhase</span><span class="p">),</span> <span class="mf">0.</span><span class="p">])</span>
        <span class="n">txGateTime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tStart</span><span class="p">,</span> <span class="n">tStart</span> <span class="o">+</span> <span class="n">hw</span><span class="o">.</span><span class="n">blkTime</span> <span class="o">+</span> <span class="n">rfTime</span><span class="p">])</span>
        <span class="n">txGateAmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">txTime</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">txAmp</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">txGateTime</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">txGateAmp</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.rfRawPulse">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.rfRawPulse">[docs]</a>
    <span class="k">def</span> <span class="nf">rfRawPulse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tStart</span><span class="p">,</span> <span class="n">rfTime</span><span class="p">,</span> <span class="n">rfAmplitude</span><span class="p">,</span> <span class="n">rfPhase</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate an RF pulse with a rectangular pulse shape.</span>

<span class="sd">        Args:</span>
<span class="sd">            tStart (float): Start time of the RF pulse.</span>
<span class="sd">            rfTime (float): Duration of the RF pulse.</span>
<span class="sd">            rfAmplitude (float): Amplitude of the RF pulse.</span>
<span class="sd">            rfPhase (float): Phase of the RF pulse in radians. Default is 0.</span>
<span class="sd">            channel (int): Channel index for the RF pulse. Default is 0.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">txTime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tStart</span><span class="p">,</span> <span class="n">tStart</span> <span class="o">+</span> <span class="n">rfTime</span><span class="p">])</span>
        <span class="n">txAmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">rfAmplitude</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">rfPhase</span><span class="p">),</span> <span class="mf">0.</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">txTime</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">txAmp</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.rxGate">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.rxGate">[docs]</a>
    <span class="k">def</span> <span class="nf">rxGate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tStart</span><span class="p">,</span> <span class="n">gateTime</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open the receiver gate for a specified channel.</span>

<span class="sd">        Args:</span>
<span class="sd">            tStart (float): Start time of the receiver gate.</span>
<span class="sd">            gateTime (float): Duration of the receiver gate.</span>
<span class="sd">            channel (int): Channel index for the receiver gate. Default is 0.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tStart</span><span class="p">,</span> <span class="n">tStart</span> <span class="o">+</span> <span class="n">gateTime</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.rxGateSync">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.rxGateSync">[docs]</a>
    <span class="k">def</span> <span class="nf">rxGateSync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tStart</span><span class="p">,</span> <span class="n">gateTime</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open a synchronized receiver gate for a specified channel with additional points to account for the time shift</span>
<span class="sd">        and ramp of the CIC filter.</span>

<span class="sd">        Args:</span>
<span class="sd">            tStart (float): Start time of the receiver gate.</span>
<span class="sd">            gateTime (float): Duration of the receiver gate.</span>
<span class="sd">            channel (int): Channel index for the receiver gate. Default is 0.</span>

<span class="sd">        Notes:</span>
<span class="sd">            - This method is designed to work with the Experiment class in the controller, which inherits from Experiment in marcos_client.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Generate instructions taking into account the cic filter delay and addRdPoints</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">samplingRate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expt</span><span class="o">.</span><span class="n">getSamplingRate</span><span class="p">()</span> <span class="o">/</span> <span class="n">hw</span><span class="o">.</span><span class="n">oversamplingFactor</span>  <span class="c1"># us</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">samplingRate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="s1">&#39;samplingPeriod&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">hw</span><span class="o">.</span><span class="n">oversamplingFactor</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">tStart</span> <span class="o">-</span> <span class="p">(</span><span class="n">hw</span><span class="o">.</span><span class="n">addRdPoints</span> <span class="o">*</span> <span class="n">hw</span><span class="o">.</span><span class="n">oversamplingFactor</span> <span class="o">-</span> <span class="n">hw</span><span class="o">.</span><span class="n">cic_delay_points</span><span class="p">)</span> <span class="o">*</span> <span class="n">samplingRate</span>  <span class="c1"># us</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">tStart</span> <span class="o">+</span> <span class="p">(</span><span class="n">hw</span><span class="o">.</span><span class="n">addRdPoints</span> <span class="o">*</span> <span class="n">hw</span><span class="o">.</span><span class="n">oversamplingFactor</span> <span class="o">+</span> <span class="n">hw</span><span class="o">.</span><span class="n">cic_delay_points</span><span class="p">)</span> <span class="o">*</span> <span class="n">samplingRate</span> <span class="o">+</span> <span class="n">gateTime</span>  <span class="c1"># us</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.ttl">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.ttl">[docs]</a>
    <span class="k">def</span> <span class="nf">ttl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tStart</span><span class="p">,</span> <span class="n">ttlTime</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a digital signal for a specified channel.</span>

<span class="sd">        Args:</span>
<span class="sd">            tStart (float): Start time of the TTL signal.</span>
<span class="sd">            ttlTime (float): Duration of the TTL signal.</span>
<span class="sd">            channel (int): Channel index for the TTL signal. Default is 0.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tStart</span><span class="p">,</span> <span class="n">tStart</span> <span class="o">+</span> <span class="n">ttlTime</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.gradTrap">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.gradTrap">[docs]</a>
    <span class="k">def</span> <span class="nf">gradTrap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tStart</span><span class="p">,</span> <span class="n">gRiseTime</span><span class="p">,</span> <span class="n">gFlattopTime</span><span class="p">,</span> <span class="n">gAmp</span><span class="p">,</span> <span class="n">gSteps</span><span class="p">,</span> <span class="n">gAxis</span><span class="p">,</span> <span class="n">shimming</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a gradient pulse with trapezoidal shape.</span>

<span class="sd">        This method generates a gradient pulse with a trapezoidal shape. One step is used to generate a rectangular</span>
<span class="sd">        pulse.</span>

<span class="sd">        Args:</span>
<span class="sd">            tStart (float): Start time of the gradient pulse.</span>
<span class="sd">            gRiseTime (float): Rise time of the gradient pulse in microseconds.</span>
<span class="sd">            gFlattopTime (float): Flattop time of the gradient pulse in microseconds.</span>
<span class="sd">            gAmp (float): Amplitude of the gradient pulse in T/m.</span>
<span class="sd">            gSteps (int): Number of steps for the gradient ramps.</span>
<span class="sd">            gAxis (int): Axis index for the gradient pulse.</span>
<span class="sd">            shimming (list): List of shimming values for each axis in arbitrary units from marcos.</span>

<span class="sd">        Notes:</span>
<span class="sd">            - Time inputs are in microseconds.</span>
<span class="sd">            - Amplitude inputs are in T/m.</span>
<span class="sd">            - shimming is in arbitrary units</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tUp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">tStart</span><span class="p">,</span> <span class="n">tStart</span> <span class="o">+</span> <span class="n">gRiseTime</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">gSteps</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">tDown</span> <span class="o">=</span> <span class="n">tUp</span> <span class="o">+</span> <span class="n">gRiseTime</span> <span class="o">+</span> <span class="n">gFlattopTime</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">tUp</span><span class="p">,</span> <span class="n">tDown</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">dAmp</span> <span class="o">=</span> <span class="n">gAmp</span> <span class="o">/</span> <span class="n">gSteps</span>
        <span class="n">aUp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">dAmp</span><span class="p">,</span> <span class="n">gAmp</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">gSteps</span><span class="p">)</span>
        <span class="n">aDown</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">gAmp</span> <span class="o">-</span> <span class="n">dAmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">gSteps</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">aUp</span><span class="p">,</span> <span class="n">aDown</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="n">hw</span><span class="o">.</span><span class="n">gFactor</span><span class="p">[</span><span class="n">gAxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">shimming</span><span class="p">[</span><span class="n">gAxis</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">gAxis</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">gAxis</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">t</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">gAxis</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">gAxis</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.gradTrapMomentum">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.gradTrapMomentum">[docs]</a>
    <span class="k">def</span> <span class="nf">gradTrapMomentum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tStart</span><span class="p">,</span> <span class="n">kMax</span><span class="p">,</span> <span class="n">gTotalTime</span><span class="p">,</span> <span class="n">gAxis</span><span class="p">,</span> <span class="n">shimming</span><span class="p">,</span> <span class="n">rewrite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a gradient pulse with trapezoidal shape according to slew rate.</span>

<span class="sd">        This method generates a gradient pulse with a trapezoidal shape based on the provided slew rate and maximum</span>
<span class="sd">        k-value.</span>

<span class="sd">        Args:</span>
<span class="sd">            tStart (float): Start time of the gradient pulse.</span>
<span class="sd">            kMax (float): Maximum k-value in 1/m.</span>
<span class="sd">            gTotalTime (float): Total time of the gradient pulse in microseconds including flattop and ramps.</span>
<span class="sd">            gAxis (int): Axis index for the gradient pulse.</span>
<span class="sd">            shimming (list): List of shimming values for each axis.</span>
<span class="sd">            rewrite (bool, optional): Whether to overwrite existing gradient data. Defaults to True.</span>

<span class="sd">        Notes:</span>
<span class="sd">            - Time inputs are in microseconds.</span>
<span class="sd">            - kMax inputs are in 1/m.</span>
<span class="sd">            - shimming is in arbitrary units</span>
<span class="sd">            - NOT FULLY TESTED</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kMax</span> <span class="o">=</span> <span class="n">kMax</span> <span class="o">/</span> <span class="n">hw</span><span class="o">.</span><span class="n">gammaB</span> <span class="o">*</span> <span class="mf">1e6</span>

        <span class="c1"># Changing from Ocra1 units</span>
        <span class="n">slewRate</span> <span class="o">=</span> <span class="n">hw</span><span class="o">.</span><span class="n">slewRate</span> <span class="o">/</span> <span class="n">hw</span><span class="o">.</span><span class="n">gFactor</span><span class="p">[</span><span class="n">gAxis</span><span class="p">]</span>  <span class="c1"># Convert to units [s*m/T]</span>
        <span class="n">stepsRate</span> <span class="o">=</span> <span class="n">hw</span><span class="o">.</span><span class="n">stepsRate</span> <span class="o">/</span> <span class="n">hw</span><span class="o">.</span><span class="n">gFactor</span><span class="p">[</span><span class="n">gAxis</span><span class="p">]</span>  <span class="c1"># Convert to units [steps*m/T]</span>

        <span class="c1"># Calculating amplitude</span>
        <span class="n">gAmplitude</span> <span class="o">=</span> <span class="p">(</span><span class="n">gTotalTime</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">gTotalTime</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">slewRate</span> <span class="o">*</span> <span class="n">kMax</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">slewRate</span><span class="p">)</span>

        <span class="c1"># Trapezoid characteristics</span>
        <span class="n">gRiseTime</span> <span class="o">=</span> <span class="n">gAmplitude</span> <span class="o">*</span> <span class="n">slewRate</span>
        <span class="n">nSteps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">gAmplitude</span> <span class="o">*</span> <span class="n">stepsRate</span><span class="p">))</span>

        <span class="c1"># Creating trapezoid</span>
        <span class="n">tRise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">tStart</span><span class="p">,</span> <span class="n">tStart</span> <span class="o">+</span> <span class="n">gRiseTime</span><span class="p">,</span> <span class="n">nSteps</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">aRise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gAmplitude</span><span class="p">,</span> <span class="n">nSteps</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">tDown</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">tStart</span> <span class="o">+</span> <span class="n">gTotalTime</span> <span class="o">-</span> <span class="n">gRiseTime</span><span class="p">,</span> <span class="n">tStart</span> <span class="o">+</span> <span class="n">gTotalTime</span><span class="p">,</span> <span class="n">nSteps</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">aDown</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">gAmplitude</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nSteps</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">gTime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">tRise</span><span class="p">,</span> <span class="n">tDown</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">gAmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">aRise</span><span class="p">,</span> <span class="n">aDown</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">hw</span><span class="o">.</span><span class="n">gFactor</span><span class="p">[</span><span class="n">gAxis</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">gAxis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expt</span><span class="o">.</span><span class="n">add_flodict</span><span class="p">({</span><span class="s1">&#39;grad_vx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">gTime</span><span class="p">,</span> <span class="n">gAmp</span> <span class="o">+</span> <span class="n">shimming</span><span class="p">[</span><span class="mi">0</span><span class="p">])},</span> <span class="n">rewrite</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">gAxis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expt</span><span class="o">.</span><span class="n">add_flodict</span><span class="p">({</span><span class="s1">&#39;grad_vy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">gTime</span><span class="p">,</span> <span class="n">gAmp</span> <span class="o">+</span> <span class="n">shimming</span><span class="p">[</span><span class="mi">1</span><span class="p">])},</span> <span class="n">rewrite</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">gAxis</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expt</span><span class="o">.</span><span class="n">add_flodict</span><span class="p">({</span><span class="s1">&#39;grad_vz&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">gTime</span><span class="p">,</span> <span class="n">gAmp</span> <span class="o">+</span> <span class="n">shimming</span><span class="p">[</span><span class="mi">2</span><span class="p">])},</span> <span class="n">rewrite</span><span class="p">)</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.setGradientRamp">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.setGradientRamp">[docs]</a>
    <span class="k">def</span> <span class="nf">setGradientRamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tStart</span><span class="p">,</span> <span class="n">gradRiseTime</span><span class="p">,</span> <span class="n">nStepsGradRise</span><span class="p">,</span> <span class="n">g0</span><span class="p">,</span> <span class="n">gf</span><span class="p">,</span> <span class="n">gAxis</span><span class="p">,</span> <span class="n">shimming</span><span class="p">,</span> <span class="n">rewrite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a gradient ramp from &#39;g0&#39; to &#39;gf&#39;.</span>

<span class="sd">        This method generates a gradient ramp from the initial amplitude &#39;g0&#39; to the final amplitude &#39;gf&#39; over the</span>
<span class="sd">        specified rise time.</span>

<span class="sd">        Args:</span>
<span class="sd">            tStart (float): Start time of the gradient ramp.</span>
<span class="sd">            gradRiseTime (float): Rise time of the gradient ramp in microseconds.</span>
<span class="sd">            nStepsGradRise (int): Number of steps in the gradient ramp.</span>
<span class="sd">            g0 (float): Initial gradient amplitude in T/m.</span>
<span class="sd">            gf (float): Final gradient amplitude in T/m.</span>
<span class="sd">            gAxis (int): Axis index for the gradient ramp.</span>
<span class="sd">            shimming (list): List of shimming values for each axis.</span>
<span class="sd">            rewrite (bool, optional): Whether to overwrite existing gradient data. Defaults to True.</span>

<span class="sd">        Notes:</span>
<span class="sd">            - Time inputs are in microseconds.</span>
<span class="sd">            - Amplitude inputs are in T/m.</span>
<span class="sd">            - shimming is in arbitrary units</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nStepsGradRise</span><span class="p">):</span>
            <span class="n">tRamp</span> <span class="o">=</span> <span class="n">tStart</span> <span class="o">+</span> <span class="n">gradRiseTime</span> <span class="o">*</span> <span class="n">kk</span> <span class="o">/</span> <span class="n">nStepsGradRise</span>
            <span class="n">gAmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">g0</span> <span class="o">+</span> <span class="p">((</span><span class="n">gf</span> <span class="o">-</span> <span class="n">g0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">kk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">nStepsGradRise</span><span class="p">))</span> <span class="o">/</span> <span class="n">hw</span><span class="o">.</span><span class="n">gFactor</span><span class="p">[</span><span class="n">gAxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">shimming</span><span class="p">[</span><span class="n">gAxis</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">gAxis</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">gAxis</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tRamp</span><span class="p">])),</span>
                                                             <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">gAxis</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">gAxis</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">gAmp</span><span class="p">])),</span>
                                                             <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.gradTrapAmplitude">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.gradTrapAmplitude">[docs]</a>
    <span class="k">def</span> <span class="nf">gradTrapAmplitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tStart</span><span class="p">,</span> <span class="n">gAmplitude</span><span class="p">,</span> <span class="n">gTotalTime</span><span class="p">,</span> <span class="n">gAxis</span><span class="p">,</span> <span class="n">shimming</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">rewrite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a gradient pulse with trapezoidal shape according to slew rate and specified amplitude.</span>

<span class="sd">        This method generates a gradient pulse with a trapezoidal shape according to the specified amplitude and slew</span>
<span class="sd">        rate.</span>

<span class="sd">        Args:</span>
<span class="sd">            tStart (float): Start time of the gradient pulse.</span>
<span class="sd">            gAmplitude (float): Amplitude of the gradient pulse in T/m.</span>
<span class="sd">            gTotalTime (float): Total duration of the gradient pulse in microseconds.</span>
<span class="sd">            gAxis (int): Axis index for the gradient pulse.</span>
<span class="sd">            shimming (list): List of shimming values for each axis.</span>
<span class="sd">            orders (int): Number of orders.</span>
<span class="sd">            rewrite (bool, optional): Whether to overwrite existing gradient data. Defaults to True.</span>

<span class="sd">        Notes:</span>
<span class="sd">            - Time inputs are in microseconds.</span>
<span class="sd">            - gAmplitude input is in T/m.</span>
<span class="sd">            - shimming is in arbitrary units</span>
<span class="sd">            - OUT OF DATE</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Changing from Ocra1 units</span>
        <span class="n">slewRate</span> <span class="o">=</span> <span class="n">hw</span><span class="o">.</span><span class="n">slewRate</span> <span class="o">/</span> <span class="n">hw</span><span class="o">.</span><span class="n">gFactor</span><span class="p">[</span><span class="n">gAxis</span><span class="p">]</span>  <span class="c1"># Convert to units [s*m/T]</span>
        <span class="n">stepsRate</span> <span class="o">=</span> <span class="n">hw</span><span class="o">.</span><span class="n">stepsRate</span> <span class="o">/</span> <span class="n">hw</span><span class="o">.</span><span class="n">gFactor</span><span class="p">[</span><span class="n">gAxis</span><span class="p">]</span>  <span class="c1"># Convert to units [steps*m/T]</span>

        <span class="c1"># Trapezoid characteristics</span>
        <span class="n">gRiseTime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">gAmplitude</span> <span class="o">*</span> <span class="n">slewRate</span><span class="p">)</span>
        <span class="n">nSteps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">gAmplitude</span> <span class="o">*</span> <span class="n">stepsRate</span><span class="p">)))</span>
        <span class="n">orders</span> <span class="o">=</span> <span class="n">orders</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nSteps</span>

        <span class="c1"># Creating trapezoid</span>
        <span class="n">tRise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">tStart</span><span class="p">,</span> <span class="n">tStart</span> <span class="o">+</span> <span class="n">gRiseTime</span><span class="p">,</span> <span class="n">nSteps</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">aRise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gAmplitude</span><span class="p">,</span> <span class="n">nSteps</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">tDown</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">tStart</span> <span class="o">+</span> <span class="n">gTotalTime</span> <span class="o">-</span> <span class="n">gRiseTime</span><span class="p">,</span> <span class="n">tStart</span> <span class="o">+</span> <span class="n">gTotalTime</span><span class="p">,</span> <span class="n">nSteps</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">aDown</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">gAmplitude</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nSteps</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">gTime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">tRise</span><span class="p">,</span> <span class="n">tDown</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">gAmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">aRise</span><span class="p">,</span> <span class="n">aDown</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">hw</span><span class="o">.</span><span class="n">gFactor</span><span class="p">[</span><span class="n">gAxis</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">gAxis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expt</span><span class="o">.</span><span class="n">add_flodict</span><span class="p">({</span><span class="s1">&#39;grad_vx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">gTime</span><span class="p">,</span> <span class="n">gAmp</span> <span class="o">+</span> <span class="n">shimming</span><span class="p">[</span><span class="mi">0</span><span class="p">])},</span> <span class="n">rewrite</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">gAxis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expt</span><span class="o">.</span><span class="n">add_flodict</span><span class="p">({</span><span class="s1">&#39;grad_vy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">gTime</span><span class="p">,</span> <span class="n">gAmp</span> <span class="o">+</span> <span class="n">shimming</span><span class="p">[</span><span class="mi">1</span><span class="p">])},</span> <span class="n">rewrite</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">gAxis</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expt</span><span class="o">.</span><span class="n">add_flodict</span><span class="p">({</span><span class="s1">&#39;grad_vz&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">gTime</span><span class="p">,</span> <span class="n">gAmp</span> <span class="o">+</span> <span class="n">shimming</span><span class="p">[</span><span class="mi">2</span><span class="p">])},</span> <span class="n">rewrite</span><span class="p">)</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.endSequence">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.endSequence">[docs]</a>
    <span class="k">def</span> <span class="nf">endSequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tEnd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finalize the sequence by setting the gradients, RX, TX, and TTL signals to zero at the specified end time.</span>

<span class="sd">        Args:</span>
<span class="sd">            tEnd (float): End time of the sequence in microseconds.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tEnd</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tEnd</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tEnd</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g2&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g2&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tEnd</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tEnd</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tEnd</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tEnd</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tEnd</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tEnd</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.iniSequence">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.iniSequence">[docs]</a>
    <span class="k">def</span> <span class="nf">iniSequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">shimming</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the sequence by setting the initial values for gradients, RX, TX, and TTL signals at the desired</span>
<span class="sd">        time.</span>

<span class="sd">        Args:</span>
<span class="sd">            t0 (float): Initial time of the sequence in microseconds.</span>
<span class="sd">            shimming (list): List of shimming values for each axis in arbitrary units.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">shimming</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">shimming</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g2&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">shimming</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.setGradient">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.setGradient">[docs]</a>
    <span class="k">def</span> <span class="nf">setGradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">gAmp</span><span class="p">,</span> <span class="n">gAxis</span><span class="p">,</span> <span class="n">rewrite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the gradient amplitude to a given value at a specified time.</span>

<span class="sd">        Args:</span>
<span class="sd">            t0 (float): Time at which the gradient is set, in microseconds.</span>
<span class="sd">            gAmp (float): Amplitude of the gradient, in arbitrary units [-1, 1].</span>
<span class="sd">            gAxis (int): Axis of the gradient (0 for x, 1 for y, 2 for z).</span>
<span class="sd">            rewrite (bool, optional): Whether to overwrite existing values. Defaults to True.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">gAxis</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">gAxis</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t0</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">gAxis</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">gAxis</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">gAmp</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.floDict2Exp">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.floDict2Exp">[docs]</a>
    <span class="k">def</span> <span class="nf">floDict2Exp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rewrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">demo</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check for errors and add instructions to Red Pitaya if no errors are found.</span>

<span class="sd">        Args:</span>
<span class="sd">            rewrite (bool, optional): Whether to overwrite existing values. Defaults to True.</span>
<span class="sd">            demo: If demo is True it just check for errors. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if no errors were found and instructions were successfully added to Red Pitaya; False otherwise.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check errors:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">::]</span> <span class="o">-</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dt</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: </span><span class="si">%s</span><span class="s2"> timing error&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: </span><span class="si">%s</span><span class="s2"> amplitude error&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Add instructions to server</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">demo</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expt</span><span class="o">.</span><span class="n">add_flodict</span><span class="p">({</span><span class="s1">&#39;grad_vx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                                   <span class="s1">&#39;grad_vy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                                   <span class="s1">&#39;grad_vz&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g2&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;g2&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                                   <span class="s1">&#39;rx0_en&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                                   <span class="s1">&#39;rx1_en&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;rx1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                                   <span class="s1">&#39;tx0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                                   <span class="s1">&#39;tx1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;tx1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                                   <span class="s1">&#39;tx_gate&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                                   <span class="s1">&#39;rx_gate&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">flo_dict</span><span class="p">[</span><span class="s1">&#39;ttl1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                                   <span class="p">},</span> <span class="n">rewrite</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.saveRawData">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.saveRawData">[docs]</a>
    <span class="k">def</span> <span class="nf">saveRawData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the rawData.</span>

<span class="sd">        This method saves the rawData to various formats including .mat, .csv, .dcm and .h5.</span>

<span class="sd">        The .mat file contains the rawData.</span>
<span class="sd">        The .csv file contains only the input parameters.</span>
<span class="sd">        The .dcm file is the DICOM image.</span>
<span class="sd">        The .h5 file is the ISMRMRD format.</span>
<span class="sd">        </span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Get directory</span>
        <span class="k">if</span> <span class="s1">&#39;directory&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;directory&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dt2</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
            <span class="n">date_string</span> <span class="o">=</span> <span class="n">dt2</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y.%m.</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;experiments/acquisitions/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">date_string</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

        <span class="c1"># generate directories for mat, csv and dcm files</span>
        <span class="n">directory_mat</span> <span class="o">=</span> <span class="n">directory</span> <span class="o">+</span> <span class="s1">&#39;/mat&#39;</span>
        <span class="n">directory_csv</span> <span class="o">=</span> <span class="n">directory</span> <span class="o">+</span> <span class="s1">&#39;/csv&#39;</span>
        <span class="n">directory_dcm</span> <span class="o">=</span> <span class="n">directory</span> <span class="o">+</span> <span class="s1">&#39;/dcm&#39;</span>
        <span class="n">directory_ismrmrd</span> <span class="o">=</span> <span class="n">directory</span> <span class="o">+</span> <span class="s1">&#39;/ismrmrd&#39;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span> <span class="o">+</span> <span class="s1">&#39;/mat&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory_mat</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span> <span class="o">+</span> <span class="s1">&#39;/csv&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory_csv</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span> <span class="o">+</span> <span class="s1">&#39;/dcm&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory_dcm</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span> <span class="o">+</span> <span class="s1">&#39;/ismrmrd&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory_ismrmrd</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">directory_rmd</span><span class="o">=</span><span class="n">directory_ismrmrd</span> 
        
        <span class="c1"># Generate filename</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">name_string</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y.%m.</span><span class="si">%d</span><span class="s2">.%H.%M.%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="s1">&#39;name_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_string</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;raw_data_name&#39;</span><span class="p">):</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_name</span><span class="p">,</span> <span class="n">name_string</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="s1">&#39;seqName&#39;</span><span class="p">]</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="s1">&#39;seqName&#39;</span><span class="p">],</span> <span class="n">name_string</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="s1">&#39;fileName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.mat&quot;</span> <span class="o">%</span> <span class="n">file_name</span>
        <span class="c1"># Generate filename for ismrmrd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="s1">&#39;fileNameIsmrmrd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.h5&quot;</span> <span class="o">%</span> <span class="n">file_name</span>
        
        <span class="c1"># Save mat file with the outputs</span>
        <span class="n">savemat</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">.mat&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">directory_mat</span><span class="p">,</span> <span class="n">file_name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">)</span> <span class="c1"># au format savemat(chemin_fichier_mat, {&quot;data&quot; : data}), avec data contient les donn√©es brute √† sauvegarder</span>

        <span class="c1"># Save csv with input parameters</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.csv&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">directory_csv</span><span class="p">,</span> <span class="n">file_name</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span> <span class="c1"># ouvrir le fichier csv en mode √©criture au format with open(chemin_fichier_csv, &#39;w&#39;, newline=&#39;&#39;) as csvfile:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mapKeys</span><span class="p">)</span> <span class="c1"># mapKeys contient les noms des colonnes du fichier csv que l&#39;on veut sauvegarder </span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span> <span class="c1"># √©crire l&#39;entete du csv les noms des colonnes dans le fichier csv</span>
            <span class="n">mapVals</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># stockage de valeurs de donn√©es √† √©crire</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapKeys</span><span class="p">:</span>  <span class="c1"># take only the inputs from mapVals</span>
                <span class="n">mapVals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="c1"># copie les donn√©e de l&#39;acquisition stock√©es dans self.mapVals dans mapVals</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerows</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">mapNmspc</span><span class="p">,</span> <span class="n">mapVals</span><span class="p">])</span> <span class="c1"># √©crire les donn√©es dans le fichier csv</span>

        <span class="c1"># Save dcm with the final image</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="c1">##verify if output is an image</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image2Dicom</span><span class="p">(</span><span class="n">fileName</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">.dcm&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">directory_dcm</span><span class="p">,</span> <span class="n">file_name</span><span class="p">))</span>

        <span class="c1"># Move seq files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_batch_files</span><span class="p">(</span><span class="n">destination_folder</span><span class="o">=</span><span class="n">directory</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.move_batch_files">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.move_batch_files">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">move_batch_files</span><span class="p">(</span><span class="n">destination_folder</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Move batch_X.seq files from the current working directory to the specified destination folder.</span>

<span class="sd">        The method scans all files in the current directory and identifies files with the extension &#39;.seq&#39;.</span>
<span class="sd">        It extracts the batch number from the file name (in the format &#39;batch_X.seq&#39;, where &#39;X&#39; is the batch number).</span>
<span class="sd">        Then, it moves these files to a subfolder &#39;seq&#39; inside the specified destination folder, renaming them based on the provided `file_name` template.</span>

<span class="sd">        Args:</span>
<span class="sd">        - destination_folder (str): The path to the destination folder where the &#39;seq&#39; subfolder will be created, and the files will be moved.</span>
<span class="sd">        - file_name (str): The prefix used for renaming the files. Files will be renamed in the format &#39;file_name_X.seq&#39;, where &#39;X&#39; is the extracted batch number from the original file name.</span>

<span class="sd">        Example:</span>
<span class="sd">            If the file &#39;batch_1.seq&#39; is found and `file_name=&#39;processed&#39;`, it will be moved and renamed to:</span>
<span class="sd">            &#39;destination_folder/seq/processed_1.seq&#39;.</span>

<span class="sd">        Side Effects:</span>
<span class="sd">        - Creates a &#39;seq&#39; subfolder in the destination folder if it doesn&#39;t already exist.</span>
<span class="sd">        - Moves and renames the matched &#39;.seq&#39; files from the current directory.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># List all files in the source folder</span>
        <span class="k">for</span> <span class="n">source_file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">():</span>
            <span class="c1"># Match files with the pattern &#39;batch_X.seq&#39;</span>
            <span class="n">file_prov</span> <span class="o">=</span> <span class="n">source_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file_prov</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;seq&#39;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">source_file</span><span class="p">):</span>
                <span class="n">batch_num</span> <span class="o">=</span> <span class="n">file_prov</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="c1"># Create the destination folder path based on the batch number</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination_folder</span><span class="p">,</span> <span class="s1">&#39;seq&#39;</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Move the file to the destination folder</span>
                <span class="n">destination_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination_folder</span><span class="p">,</span> <span class="s1">&#39;seq&#39;</span><span class="p">,</span> <span class="n">file_name</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">.seq&#39;</span> <span class="o">%</span> <span class="n">batch_num</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">source_file</span><span class="p">,</span> <span class="n">destination_file</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Moved: </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">destination_folder</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.image2Dicom">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.image2Dicom">[docs]</a>
    <span class="k">def</span> <span class="nf">image2Dicom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileName</span><span class="p">):</span> 
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the DICOM image.</span>

<span class="sd">        This method saves the DICOM image with the given filename.</span>

<span class="sd">        Args:</span>
<span class="sd">            fileName (str): The filename to save the DICOM image.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create DICOM object</span>
        <span class="n">dicom_image</span> <span class="o">=</span> <span class="n">DICOMImage</span><span class="p">()</span>

        <span class="c1"># Save image into DICOM object</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dicom_image</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;PixelData&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;PixelData&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
            <span class="n">dicom_image</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;PixelData&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
            <span class="c1"># If it is a 3D image</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># Get dimensions</span>
                <span class="n">slices</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">dicom_image</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;Columns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">columns</span>
                <span class="n">dicom_image</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;Rows&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span>
                <span class="n">dicom_image</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;NumberOfSlices&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">slices</span>
                <span class="n">dicom_image</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;NumberOfFrames&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">slices</span>
            <span class="c1"># If it is a 2D image</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Get dimensions</span>
                <span class="n">rows</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">dicom_image</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;Columns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">columns</span>
                <span class="n">dicom_image</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;Rows&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span>
                <span class="n">dicom_image</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;NumberOfSlices&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">dicom_image</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;NumberOfFrames&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Date and time</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;StudyDate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;StudyTime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H%M%S&quot;</span><span class="p">)</span>

        <span class="c1"># More DICOM tags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;PatientName&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;PatientSex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;StudyID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;InstitutionName&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;scanner&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;ImageComments&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;PatientID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;SOPInstanceUID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="s1">&#39;name_string&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;SeriesDescription&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;seriesNumber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;seriesNumber&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;SeriesNumber&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;seriesNumber&#39;</span><span class="p">]</span>
        <span class="c1"># Full dynamic window</span>
        <span class="c1"># self.meta_data[&quot;WindowWidth&quot;] = 26373</span>
        <span class="c1"># self.meta_data[&quot;WindowCenter&quot;] = 13194</span>

        <span class="c1"># Update the DICOM metadata</span>
        <span class="n">dicom_image</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">)</span>

        <span class="c1"># Save metadata dictionary into DICOM object metadata (Standard DICOM 3.0)</span>
        <span class="n">dicom_image</span><span class="o">.</span><span class="n">image2Dicom</span><span class="p">()</span> 

        <span class="c1"># Save DICOM file</span>
        <span class="n">dicom_image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.addParameter">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.addParameter">[docs]</a>
    <span class="k">def</span> <span class="nf">addParameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">tip</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a parameter to the sequence.</span>

<span class="sd">        This method adds a parameter to the sequence with the specified key, description string, value, units, field,</span>
<span class="sd">        and tip.</span>

<span class="sd">        Args:</span>
<span class="sd">            key (str): The key of the parameter.</span>
<span class="sd">            string (str): The description string of the parameter.</span>
<span class="sd">            val (int/float/str/list): The value of the parameter. It can be an integer, a float, a string, or a list.</span>
<span class="sd">            units (bool): Indicates the units of the parameter (e.g. cm -&gt; 1e-2, or you can use the config/units.py module).</span>
<span class="sd">            field (str): The field of the parameter: &#39;RF&#39;, &#39;IMG&#39;, &#39;SEQ&#39;, &#39;OTH&#39;.</span>
<span class="sd">            tip (str): Additional information or tip about the parameter.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mapKeys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapNmspc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapFields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapTips</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">tip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_units</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mapLen</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mapLen</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.sequenceAtributes">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.sequenceAtributes">[docs]</a>
    <span class="k">def</span> <span class="nf">sequenceAtributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add input parameters to the sequence object.</span>

<span class="sd">        This method iterates over the input parameters and adds them as attributes to the sequence object (self). It</span>
<span class="sd">        multiplies each parameter by its corresponding unit if units are specified (e.g. key = &#39;f0&#39;, val = 3,</span>
<span class="sd">        units = 1e-6 will create self.f0 = 3e-6.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapKeys</span><span class="p">:</span> 
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span> 
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">element</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_units</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="n">key</span><span class="p">]]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_units</span><span class="p">[</span><span class="n">key</span><span class="p">])</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.plotResults">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.plotResults">[docs]</a>
    <span class="k">def</span> <span class="nf">plotResults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot results in a standalone window.</span>

<span class="sd">        This method generates plots based on the output data provided. It creates a plot window, inserts each plot</span>
<span class="sd">        according to its type (image or curve), sets titles and labels, and displays the plot.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Determine the number of columns and rows for subplots</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;row&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">rows</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">cols</span><span class="p">:</span>
                <span class="n">cols</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Create the plot window</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

        <span class="c1"># Insert plots</span>
        <span class="n">plot</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
                <span class="n">nz</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">plot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">nz</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;xLabel&#39;</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;yLabel&#39;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;curve&#39;</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">plot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">y_data</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;yData&#39;</span><span class="p">]:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;xData&#39;</span><span class="p">],</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;legend&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">])</span>
                    <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;xLabel&#39;</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;yLabel&#39;</span><span class="p">])</span>
            <span class="n">plot</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Set the figure title</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="s1">&#39;fileName&#39;</span><span class="p">])</span>

        <span class="c1"># Adjust the layout to prevent overlapping titles</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1"># Show the plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.getParameter">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.getParameter">[docs]</a>
    <span class="k">def</span> <span class="nf">getParameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the value of a parameter.</span>

<span class="sd">        Args:</span>
<span class="sd">            key (str): The key corresponding to the parameter.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The value of the parameter associated with the given key.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.setParameter">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.setParameter">[docs]</a>
    <span class="k">def</span> <span class="nf">setParameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the value of a parameter.</span>

<span class="sd">        Args:</span>
<span class="sd">            key (str): The key corresponding to the parameter.</span>
<span class="sd">            string (str): String that will be shown in the GUI</span>
<span class="sd">            val (Any): The new value to be assigned to the parameter.</span>
<span class="sd">            unit (bool): The unit of the parameter.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapVals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapNmspc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_units</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">unit</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.fix_image_orientation">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.fix_image_orientation">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">fix_image_orientation</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">axes</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adjusts the orientation of a 3D image array to match standard anatomical planes</span>
<span class="sd">        (sagittal, coronal, or transversal) and returns the oriented image along with labeling</span>
<span class="sd">        and metadata for visualization.</span>

<span class="sd">        Args:</span>
<span class="sd">            image (np.ndarray): A 3D numpy array representing the image data to be reoriented.</span>
<span class="sd">            axes (list[int]): A list of three integers representing the current order of the</span>
<span class="sd">                              axes in the image (e.g., [0, 1, 2] for x, y, z).</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing the following keys:</span>
<span class="sd">                - &#39;widget&#39;: A fixed string &quot;image&quot; or &quot;curve&quot; indicating the type of data for visualization.</span>
<span class="sd">                - &#39;data&#39;: The reoriented 3D image array (np.ndarray).</span>
<span class="sd">                - &#39;xLabel&#39;: A string representing the label for the x-axis in the visualization.</span>
<span class="sd">                - &#39;yLabel&#39;: A string representing the label for the y-axis in the visualization.</span>
<span class="sd">                - &#39;title&#39;: A string representing the title of the visualization (e.g., &quot;Sagittal&quot;).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get axes in strings</span>
        <span class="n">axes_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
        <span class="n">axes_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">axes_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">axes_vals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">axes_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">axes_str</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">axes_vals</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="n">axes_str</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">axes_keys</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Create output dictionaries to plot figures</span>
        <span class="n">x_label</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> axis&quot;</span> <span class="o">%</span> <span class="n">axes_str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> axis&quot;</span> <span class="o">%</span> <span class="n">axes_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Image&quot;</span>
        <span class="k">if</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Sagittal</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Sagittal&quot;</span>
            <span class="k">if</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">x_label</span> <span class="o">=</span> <span class="s2">&quot;(-Y) A | PHASE | P (+Y)&quot;</span>
                <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;(-X) I | READOUT | S (+X)&quot;</span>
                <span class="n">image_orientation_dicom</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">x_label</span> <span class="o">=</span> <span class="s2">&quot;(-Y) A | READOUT | P (+Y)&quot;</span>
                <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;(-X) I | PHASE | S (+X)&quot;</span>
                <span class="n">image_orientation_dicom</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Coronal</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Coronal&quot;</span>
            <span class="k">if</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">x_label</span> <span class="o">=</span> <span class="s2">&quot;(+Z) R | PHASE | L (-Z)&quot;</span>
                <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;(-X) I | READOUT | S (+X)&quot;</span>
                <span class="n">image_orientation_dicom</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">x_label</span> <span class="o">=</span> <span class="s2">&quot;(+Z) R | READOUT | L (-Z)&quot;</span>
                <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;(-X) I | PHASE | S (+X)&quot;</span>
                <span class="n">image_orientation_dicom</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Transversal</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Transversal&quot;</span>
            <span class="k">if</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">x_label</span> <span class="o">=</span> <span class="s2">&quot;(+Z) R | PHASE | L (-Z)&quot;</span>
                <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;(+Y) P | READOUT | A (-Y)&quot;</span>
                <span class="n">image_orientation_dicom</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">x_label</span> <span class="o">=</span> <span class="s2">&quot;(+Z) R | READOUT | L (-Z)&quot;</span>
                <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;(+Y) P | PHASE | A (-Y)&quot;</span>
                <span class="n">image_orientation_dicom</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>

        <span class="n">output</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;widget&#39;</span><span class="p">:</span> <span class="s1">&#39;image&#39;</span><span class="p">,</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">image</span><span class="p">,</span>
            <span class="s1">&#39;xLabel&#39;</span><span class="p">:</span> <span class="n">x_label</span><span class="p">,</span>
            <span class="s1">&#39;yLabel&#39;</span><span class="p">:</span> <span class="n">y_label</span><span class="p">,</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.runIFFT">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.runIFFT">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">runIFFT</span><span class="p">(</span><span class="n">k_space</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform inverse FFT reconstruction.</span>

<span class="sd">        This method performs the inverse Fourier transform to reconstruct the image in the spatial domain from k-space</span>
<span class="sd">        data.</span>

<span class="sd">        Args:</span>
<span class="sd">            k_space (ndarray): The k-space data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ndarray: The reconstructed image in the spatial domain.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftn</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">k_space</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">image</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.runDFFT">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.runDFFT">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">runDFFT</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform direct FFT reconstruction.</span>

<span class="sd">        This method performs the direct Fourier transform to obtain the k-space data from an image in the spatial</span>
<span class="sd">        domain.</span>

<span class="sd">        Args:</span>
<span class="sd">            image (ndarray): The image in the spatial domain.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ndarray: The k-space data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">k_space</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">image</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">k_space</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.runBm4dFilter">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.runBm4dFilter">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">runBm4dFilter</span><span class="p">(</span><span class="n">image_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply the BM4D filter to denoise the image.</span>

<span class="sd">        This method retrieves the image data, rescales it, calculates the standard deviation for the BM4D filter,</span>
<span class="sd">        applies the BM4D filter to denoise the rescaled image, and rescales the denoised image back to its original</span>
<span class="sd">        scale.</span>

<span class="sd">        Args:</span>
<span class="sd">            image_data (ndarray): The input image data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ndarray: The denoised image.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Rescale the image data for processing</span>
        <span class="n">reference</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span>
        <span class="n">image_rescaled</span> <span class="o">=</span> <span class="n">image_data</span> <span class="o">/</span> <span class="n">reference</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="c1"># Calculate the standard deviation for BM4D filter</span>
        <span class="c1"># (Code to calculate the standard deviation is included here)</span>

        <span class="c1"># Create a BM4D profile and set options</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">bm4d</span><span class="o">.</span><span class="n">BM4DProfile</span><span class="p">()</span>
        <span class="n">stage_arg</span> <span class="o">=</span> <span class="n">bm4d</span><span class="o">.</span><span class="n">BM4DStages</span><span class="o">.</span><span class="n">ALL_STAGES</span>
        <span class="n">blockmatches</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Apply the BM4D filter to the rescaled image</span>
        <span class="n">denoised_rescaled</span> <span class="o">=</span> <span class="n">bm4d</span><span class="o">.</span><span class="n">bm4d</span><span class="p">(</span><span class="n">image_rescaled</span><span class="p">,</span> <span class="n">sigma_psd</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">profile</span><span class="p">,</span> <span class="n">stage_arg</span><span class="o">=</span><span class="n">stage_arg</span><span class="p">,</span>
                                      <span class="n">blockmatches</span><span class="o">=</span><span class="n">blockmatches</span><span class="p">)</span>

        <span class="c1"># Rescale the denoised image back to its original dimensions</span>
        <span class="n">denoised_image</span> <span class="o">=</span> <span class="n">denoised_rescaled</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">reference</span>

        <span class="k">return</span> <span class="n">denoised_image</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.runCosbellFilter">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.runCosbellFilter">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">runCosbellFilter</span><span class="p">(</span><span class="n">sampled</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cosbell_order</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply the Cosbell filter operation to the k-space data along three directions.</span>

<span class="sd">        This method applies the Cosbell filter to the k-space data along the readout (&#39;rd&#39;), phase (&#39;ph&#39;), and slice</span>
<span class="sd">        (&#39;sl&#39;) directions. It modifies the input k-space data in-place.</span>

<span class="sd">        Args:</span>
<span class="sd">            sampled (ndarray): The sampled k-space coordinates in a nx3 matrix, where n is the number of points in k-space. The three columns correspond to the readout, phase, and slice directions.</span>
<span class="sd">            data (ndarray): The 3D matrix representing the k-space data to be filtered (sl, ph, rd).</span>
<span class="sd">            cosbell_order (int): The order of the Cosbell filter.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ndarray: The filtered k-space data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nPoints</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># Along readout</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sampled</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">nPoints</span><span class="p">)</span>
        <span class="n">kmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">k</span><span class="p">[:]))</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">k</span> <span class="o">/</span> <span class="n">kmax</span>
        <span class="n">data</span> <span class="o">*=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">**</span> <span class="n">cosbell_order</span><span class="p">)</span>

        <span class="c1"># Along phase</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sampled</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">nPoints</span><span class="p">)</span>
        <span class="n">kmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">k</span><span class="p">[:]))</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">k</span> <span class="o">/</span> <span class="n">kmax</span>
        <span class="n">data</span> <span class="o">*=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">**</span> <span class="n">cosbell_order</span><span class="p">)</span>

        <span class="c1"># Along slice</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sampled</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">nPoints</span><span class="p">)</span>
        <span class="n">kmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">k</span><span class="p">[:]))</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">k</span> <span class="o">/</span> <span class="n">kmax</span>
        <span class="n">data</span> <span class="o">*=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">**</span> <span class="n">cosbell_order</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.runZeroPadding">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.runZeroPadding">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">runZeroPadding</span><span class="p">(</span><span class="n">k_space</span><span class="p">,</span> <span class="n">zero_padding_order</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform the zero-padding operation on k-space data.</span>

<span class="sd">        This method applies zero-padding to the loaded k-space data to increase its size.</span>
<span class="sd">        The padding order is specified for each dimension: readout (rd), phase (ph), and slice (sl).</span>
<span class="sd">        The padded k-space data is returned as a new matrix.</span>

<span class="sd">        Args:</span>
<span class="sd">            k_space (ndarray): The 3D matrix k-space data to be zero-padded.</span>
<span class="sd">            zero_padding_order (str): The zero-padding order for each dimension represented as a string.</span>
<span class="sd">                The order should consist of three integers specifying the padding factor for the readout, phase, and</span>
<span class="sd">                slice dimensions, respectively.</span>

<span class="sd">        Returns:sa</span>
<span class="sd">            ndarray: The 3D matrix containing the zero-padded k-space data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Zero-padding order for each dimension from the text field</span>
        <span class="n">rd_order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">zero_padding_order</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ph_order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">zero_padding_order</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">sl_order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">zero_padding_order</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Get the shape of the current k-space data</span>
        <span class="n">current_shape</span> <span class="o">=</span> <span class="n">k_space</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># Determine the new shape after zero-padding</span>
        <span class="n">new_shape</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">current_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sl_order</span><span class="p">,</span>
            <span class="n">current_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">ph_order</span><span class="p">,</span>
            <span class="n">current_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">rd_order</span>
        <span class="p">)</span>

        <span class="c1"># Create an image matrix filled with zeros</span>
        <span class="n">image_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">new_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

        <span class="c1"># Get the dimensions of the current k-space data</span>
        <span class="n">image_height</span> <span class="o">=</span> <span class="n">current_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">image_width</span> <span class="o">=</span> <span class="n">current_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">image_depth</span> <span class="o">=</span> <span class="n">current_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Calculate the centering offsets for each dimension</span>
        <span class="n">col_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">image_height</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">row_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">image_width</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">depth_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">image_depth</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

        <span class="c1"># Calculate the start and end indices to center the k-space within the image_matrix</span>
        <span class="n">col_start</span> <span class="o">=</span> <span class="n">col_offset</span>
        <span class="n">col_end</span> <span class="o">=</span> <span class="n">col_start</span> <span class="o">+</span> <span class="n">image_height</span>
        <span class="n">row_start</span> <span class="o">=</span> <span class="n">row_offset</span>
        <span class="n">row_end</span> <span class="o">=</span> <span class="n">row_start</span> <span class="o">+</span> <span class="n">image_width</span>
        <span class="n">depth_start</span> <span class="o">=</span> <span class="n">depth_offset</span>
        <span class="n">depth_end</span> <span class="o">=</span> <span class="n">depth_start</span> <span class="o">+</span> <span class="n">image_depth</span>

        <span class="c1"># Copy the k-space data into the image_matrix at the center</span>
        <span class="n">image_matrix</span><span class="p">[</span><span class="n">col_start</span><span class="p">:</span><span class="n">col_end</span><span class="p">,</span> <span class="n">row_start</span><span class="p">:</span><span class="n">row_end</span><span class="p">,</span> <span class="n">depth_start</span><span class="p">:</span><span class="n">depth_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">k_space</span>

        <span class="k">return</span> <span class="n">image_matrix</span></div>


<div class="viewcode-block" id="MRIBLANKSEQ.autoProcessing">
<a class="viewcode-back" href="../../seq.html#seq.mriBlankSeq.MRIBLANKSEQ.autoProcessing">[docs]</a>
    <span class="k">def</span> <span class="nf">autoProcessing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sampled</span><span class="p">,</span> <span class="n">k_space</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform automated processing on k-space data.</span>

<span class="sd">        This method performs a series of processing steps on the k-space data to generate an image.</span>
<span class="sd">        The steps include inverse FFT, BM4D filtering, direct FFT, Cosbell filtering, zero-padding, and inverse FFT.</span>

<span class="sd">        Args:</span>
<span class="sd">            sampled (ndarray): The sampled k-space data.</span>
<span class="sd">            k_space (ndarray): The k-space data to be processed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ndarray: The processed image generated from the k-space data after automated processing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Perform inverse FFT to reconstruct the image in the spatial domain</span>
        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runIFFT</span><span class="p">(</span><span class="n">k_space</span><span class="p">)</span>

        <span class="c1"># Apply the BM4D filter to denoise the image</span>
        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runBm4dFilter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>

        <span class="c1"># Perform direct FFT to transform the denoised image back to k-space</span>
        <span class="n">k_sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runDFFT</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

        <span class="c1"># Apply the Cosbell filter to k-space data in three directions</span>
        <span class="n">k_sp_cb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runCosbellFilter</span><span class="p">(</span><span class="n">sampled</span><span class="p">,</span> <span class="n">k_sp</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>

        <span class="c1"># Perform zero-padding on the Cosbell-filtered k-space data</span>
        <span class="n">k_sp_zp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runZeroPadding</span><span class="p">(</span><span class="n">k_sp_cb</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span>

        <span class="c1"># Perform inverse FFT to reconstruct the final image</span>
        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runIFFT</span><span class="p">(</span><span class="n">k_sp_zp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">image</span></div>
</div>



</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, J.M. Algar√≠n.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>